<html lang="en">

<head>
  <!-- <link rel="stylesheet" href="../paged-media/highlight/styles/solarized-light.css"> -->
  <link rel="stylesheet" href="../paged-media/prism/prism.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">
  <title></title>
</head>

<body data-type="book">

  <h1>Service Workers With Streams</h1>
<p>Jake Archibald posted an article about <a href="https://jakearchibald.com/2016/streams-ftw/#creating-one-stream-from-multiple-sources-to-supercharge-page-render-times">combining streams and the cache API in a service worker</a> to further improve rendering times I became curious and wanted to learn more about how it works.</p>
<p>This approach makes the following assumptions</p>
<ol>
<li>It works with resources from the same origin</li>
<li>We only want the content from certain areas to stream, the rest of the content can go through regular fetch (cache then network)</li>
<li>We have broken the start and end portions of our pages into separate include files</li>
<li>We precache the start and end of our streamed content</li>
</ol>
<pre><code class="language-javascript">var stream = new ReadableStream({
  start(controller) {
  // Get promises for response objects for each page part
  // The start and end come from a cache
  var startFetch = caches.match('/page-start.inc');
  var endFetch = caches.match('/page-end.inc');
  // The middle comes from the network, with a fallback
  var middleFetch = fetch('/page-middle.inc')
    .catch(() =&gt; caches.match('/page-offline-middle.inc'));

  function pushStream(stream) {
    // Get a lock on the stream
    var reader = stream.getReader();

    return reader.read().then(function process(result) {
      if (result.done) return;
      // Push the value to the combined stream
      controller.enqueue(result.value);
      // Read more &amp; process
      return reader.read().then(process);
    });
  }

  // Get the start response
  startFetch
    // Push its contents to the combined stream
    .then(response =&gt; pushStream(response.body))
    // Get the middle response
    .then(() =&gt; middleFetch)
    // Push its contents to the combined stream
    .then(response =&gt; pushStream(response.body))
    // Get the end response
    .then(() =&gt; endFetch)
    // Push its contents to the combined stream
    .then(response =&gt; pushStream(response.body))
    // Close our stream, we're done!
    .then(() =&gt; controller.close());
}
</code></pre>
<p>The problem with this example as written (and I understand that itâ€™s an example, not working code) is that the <code>middle-fetch</code> portion is locked</p>
<h2>The easier way</h2>
<p><a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.streams">https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.streams</a></p>


<!-- <script src="../paged-media/highlight/highlight.pack.js"></script> -->
<script src="../paged-media/prism/prism.js"></script>
</body>
</html>