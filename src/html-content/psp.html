<h1 id="long-form-publishing-with-progressive-subcompact-applications">Long form publishing with progressive subcompact applications</h1>
<p>For the past few months I’ve been working at Google building a set of instructor-led courses on how to build progressive web applications. This has made me think of how to push some of these concepts into what I call “Progressive subcompact publications”.  These concepts are different than ePub Next and any number of formats vining for use, each of which have issues that are hard to overcome:</p>
<ul>
<li>They seek to replace the installed EPUB (and Kindle) user base.  Since most users of iBooks and Kindles are locked in to their devices and readers this is not a good idea</li>
<li>There will never be uniform buy in to new specs or ways to publish content and, unless you can get a majority of publishers to implement your specification, schema or idea you will be competing with a behemoth that is very slow to evolve (not questioning the reasons, just making a statement)</li>
<li>Some people are trying to establish their format as a defacto standard (use this instead of what you already have) and that’s dangerous
<ul>
<li>It’s dangerous if you fail to get full buy in because it segments the market even further</li>
<li>it’s dangerous if you succeed because the defacto standard becomes a de jure standard and you have to support it and work all the warts that were ok when you were developing it (check the Javascript specifications for the amount of baggage carried over to keep old code from breaking)</li>
</ul>
</li>
</ul>
<p>Instead I’m looking at progressive subcompact publications as a starting point for an exploration of how far we can push the web as a publishing medium.</p>
<h2 id="what-are-progressive-web-applications">What are progressive web applications</h2>
<p>Alex Rusell  coined the term “Progressive Web Applications” in <a href="https://infrequently.org/2015/06/progressive-apps-escaping-tabs-without-losing-our-soul/">Progressive Web Apps: Escaping Tabs Without Losing Our Soul</a>. It is an umbrella term for a series of technologies and best practices to make our users experience feel more like native applications without loosing what makes the web awesome. The characteristics of these apps (as defined in the post) are:</p>
<ul>
<li>Responsive: to fit any form factor</li>
<li>Connectivity independent: Progressively-enhanced with Service Workers to let them work offline</li>
<li>App-like-interactions: Adopt a Shell + Content application model to create appy navigations &amp; interactions</li>
<li>Fresh: Transparently always up-to-date thanks to the Service Worker update process</li>
<li>Safe: Served via TLS (a Service Worker requirement) to prevent snooping</li>
<li>Discoverable: Are identifiable as “applications” thanks to W3C Manifests and Service Worker registration scope allowing search engines to find them</li>
<li>Re-engageable: Can access the re-engagement UIs of the OS; e.g. Push Notifications</li>
<li>Installable in mobile: to the home screen through browser-provided prompts, allowing users to “keep” apps they find most useful without the hassle of an app store</li>
<li>Linkable: meaning they’re zero-friction, zero-install, and easy to share. The social power of URLs matters.</li>
</ul>
<p>Note that none of these ideas involve implementing new technologies. They are all in the specification pipeline at W3C or WHATWG and have multiple browser implementations already in the market.</p>
<p>These technologies also don’t stop you from using the new, shinny and awesome stuff coming down in CSS, Javascript and related APIs and technologies. Nothing stops you from using WebGL 2.0, CSS Grids and other awesomeness now available or coming soon to your browsers.</p>
<p>We will also briefly explore what it would take to make PSPs into full desktop and mobile applications using Electron and Apache Cordoba / Adobe PhoneGap. Again this is not meant to be a perfect solution but an exploration of possibilities.</p>
<h2 id="what-is-subcompact-publishing">What is subcompact publishing</h2>
<blockquote>
<p>It seems that perfection is attained, not when there is nothing more to add, but when there is nothing more to take away.
Antoine de Saint Exupéry</p>
</blockquote>
<p>The term <a href="http://craigmod.com/journal/subcompact_publishing/">Subcompact Publishing</a> was coined by Craig Mod to describe a new and different publishing methodology rooted in the digital world rather than an extension of traditional publishing methods and systems.</p>
<p>According to Mod:</p>
<ul>
<li>Subcompact Publishing tools are first and foremost straightforward and require few to no instructions. Compare this to the instructions on how to navigate the current crop of digital magazines</li>
</ul>
  <figure><img src="http://craigmod.com/images/journal/subcompact/tutorials06.jpg" alt="" width="75%"/></figure>
  <figure><img src="http://craigmod.com/images/journal/subcompact/tutorials05.jpg" alt="" width="75%"/></figure>
  <figure><img src="http://craigmod.com/images/journal/subcompact/tutorials03.png" alt="" width="75%"/></figure>
<ul>
<li>
<p>The editorial and design decisions around them react to digital as a distribution and consumption space. We no longer buy print magazines but read them online. How can we leverage the online publishing and reading experiences?</p>
</li>
<li>
<p>They are the result of dumping our publishing related technology on a table and asking ourselves — what are the core tools we can build with all this stuff? Don’t think of online as just an extension of print but explore what things you can do only online and how that enhances the reader’s experience</p>
</li>
</ul>
<p>Furthermore Craig describes subcompact publications as having the following characteristics:</p>
<ul>
<li><strong>Small issue sizes (3-7 articles / issue)</strong></li>
<li><strong>Small file sizes</strong></li>
<li><strong>Digital-aware subscription prices</strong></li>
<li><strong>Fluid publishing schedule</strong></li>
<li><strong>Scroll (don’t paginate)</strong></li>
<li><strong>Clear navigation</strong></li>
<li><strong>HTML(ish) based</strong></li>
<li><strong>Touching the open web</strong></li>
</ul>
<p>Reading the essay it shows that it’s geared towards magazines but, with a few modifications, it applies equally to books and other long form content.  For this project, geared towards books and other collection types of publications, I’ve changed some of the definitions of Subcompact Publishing as listed below:</p>
<ul>
<li>
<p><strong>Small issue sizes (3-7 articles / issue) / Small file sizes</strong> Because we are using technologies that allow us to load content on demand and to cache the content on the user’s browser the need to keep the content small, both issue size and file size becomes less relevant. We can load the shell of our book independently of the content and load the content in smaller bites. For example we can load the first 10 chapters of a book right away and then load the rest of the content on demand. This does not mean we should forget about best practices in compressing and delivering the content but with Service Workers and caching available we can worry more about the content itself rather than how it’s delivered. If we add http2 and server push to the mix  the speed gain becomes significant if implemented correctly</p>
</li>
<li>
<p><strong>Fluid publishing schedule</strong> Because we can update the content of our web publications whenever it’s necessary we can push new or updated content at any point, without having to worry about releasing the entire package again or having to go through a vendor’s store approval process</p>
</li>
<li>
<p><strong>Scroll (don’t paginate)</strong> Unless we have a compelling reason</p>
</li>
<li>
<p><strong>Clear navigation</strong> We have trained our users to accept certain metaphors for navigating our web applications. There is no compelling reason to change that now and, if there is, it better be a very good reason</p>
</li>
<li>
<p><strong>HTML based</strong> Here is the main divergent point from Craig’s conception of subcompact publications. PSPs are meant for the web and, if the developer chooses, for HTML-based publishing formats. iBooks and, especially, Kindle are closed ecosystems where it’s very difficult to get in to the ecosystem beyond using the tools they provide to adapt your format to their specifications…  It is already hard enough to work with different browsers and the uneven CSS support… There is one browser among the major vendors that supports epub natively (thank you, Edge)</p>
</li>
<li>
<p><strong>Using the open web</strong> One of the biggest draws of the web is that it requires no installation proccess or approval for content delivery to the end users. Leveraging this makes the idea of Progressive Subcompact publications easier to work with, even if DRM and other rights management issues are not tackled from the start</p>
</li>
</ul>
<p>This is how a progressive web application looks like. It may also be how our web reading experiences look like in the not too distant future</p>
  <figure><img src="https://developers.google.com/web/fundamentals/engage-and-retain/app-install-banners/images/add-to-home-screen.gif" alt="Progressive web application - Taken from Google's Using App Install Banners" width="75%"/></figure>
<h2 id="how-does-this-all-work%3F">How does this all work?</h2>
<p>At the core of our progressive subcompact publications is a service worker.  This woker is a type of shared worker and it also works as a network proxy for your requests, you can cache responses, provide new responses based on the request you make, provide the basic mechanism to do push notifications and content synchronization in the background.</p>
<p>We’ll break down the service worker in two sections: the script and the installation script you add to your entry point (usually <code>index.html</code>)</p>
<h3 id="service-worker%3A-the-script">Service worker: The script</h3>
<p>This is a fairly common pattern to build a service worker that will perform the following tasks:</p>
<ul>
<li>Caches the content of our application shell</li>
<li>Automatically cleans up old cached content when the service worker is updated</li>
<li>Fetches app resources using a ‘cache first strategy’. If the content requested is in the cache then serve it from there. If it’s not on the cache then make a network request for the resource, serve it to the user and put it in the cache for later requests</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token constant">CACHE_NAME</span> <span class="token operator">=</span> <span class="token string">'my-site-cache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cacheWhitelist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> urlsToCache <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token string">'/'</span><span class="token punctuation">,</span>
	<span class="token string">'/styles/main.css'</span><span class="token punctuation">,</span>
	<span class="token string">'/script/main.js'</span><span class="token punctuation">,</span>
	<span class="token string">'images/banner.png'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Opened cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>urlsToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        cacheNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheWhitelist<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
	      <span class="token punctuation">}</span><span class="token punctuation">)</span>
	   	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
  caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Check if we received a valid response</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'unable to retrieve file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token keyword">var</span> responseToCache <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> responseToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Service Worker] unable to complete the request: '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>There are things that we are not covering on purpose for the sake of keeping the code short. Some of these things include:</p>
<ul>
<li>For this example we’ve assumed a minimal set of elements to cache for the application shell. We can be more detailed and add fonts and other static resources. We may also assign the array of items to cache on install to a variable to make it easier to work with</li>
<li>Providing a solution for when the content is not in the cache and the network is not available. We can cache default feedback for text-based content or programmatically generate an svg image for fallback</li>
<li>Putting content in different caches so deleting one group of resources doesn’t delete all of them</li>
<li>We make no effort to add hashes to the resources we cache so we can do proper HTTP cache busting when needed</li>
</ul>
<p>But at 60 lines of Javascript that will work in 3 of the 5 major browsers (and soon in all of them) I think it does a pretty good job.</p>
<h3 id="service-worker%3A-the-registration">Service worker: The registration</h3>
<p>Assuming that we saved the service worker as <code>sw.js</code> we can write the code below inside a script tag on our entry page (<code>index.html</code>).</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker is supported'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'sw.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Yay!'</span><span class="token punctuation">,</span> reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'boo!'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This script checks for service worker support by testing if the string <code>serviceWorker</code> exists in the navigator object. If it does then service workers are supported, we log a message to the console and then register the serviceworker.</p>
<p>If the serviceWorker string doesn’t exist in the navigator object then service workers are not supported. The catch statement will trigger and we log something to the console.</p>
<p>That’s it. The combination of those two scripts gives us consistent performance across devices and the possibility of work offline after accessing the content once while online.</p>
<h2 id="service-worker%3A-push-notifications">Service Worker: Push Notifications</h2>
<p>Using Push notifications we can communicate events and new information to the user through the Operating System’s push notification system and UI.</p>
<figure>
  <img src="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/images/cc-good.png" alt="" />
</figure>
<p>A good introduction to Push notiications is the Google Developers article:  <a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/">Push Notifications: Timely, Relevant, and Precise</a>. It provids a context for how and when to use push notifications.</p>
<p>Google provides Firebase Cloud Messaging as the server component of push notifications. It makes sense since it’s a Google product but, in my opinion, it makes it harder to streamline the development process (particularly in trying to figure out where they placed the ID that you need to configure push messaging and notifications).</p>
<p>There are other alternatives I’m currently researching.</p>
<h2 id="background-sync">Background Sync</h2>
<p>If you write an email, instant message, or simply favourite a tweet, the application needs to communicate that data to the server. If that fails, either due to user connectivity, service availability or anything in-between, the app can store that action in some kind of ‘outbox’ for retry later.</p>
<p>Unfortunately, on the web, that outbox can only be processed while the site is displayed in a browsing context. This is particularly problematic on mobile, where browsing contexts are frequently shut down to free memory.</p>
<p>This API provides a web equivalent to native application platforms’ <a href="https://developer.android.com/reference/android/app/job/JobScheduler.html">job scheduling APIs</a> that enable developers to collaborate with the system to ensure low power usage and background-driven processing. The web platform needs capabilities like this too.</p>
<p>We need to check if the user is online or not. For this we use <code>navigator.online</code> to test the device’s connectivity status.</p>
<p>This is a basic test but it’s not foolproof.  A flase result will always be false but a positive result will not always be true as the user may be caught in ‘lie-fi’, a status where the devices reports connectivity but there is no real network to access.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Connection Status</span>
  <span class="token keyword">function</span> <span class="token function">isOnline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> connectionStatus <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'connectionStatus'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">)</span><span class="token punctuation">{</span>
      connectionStatus<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'You are currently online!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      connectionStatus<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'You are currently offline. '</span> <span class="token operator">+</span>
      <span class="token string">'Any requests made will be queued and synced as soon as you '</span><span class="token operator">+</span>
      <span class="token string">'are connected again.'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">isOnline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>When we register the Service Worker we add a click event handled to take care of sync registration. This event will activate the sync registrration and return a promise that will resolve when the sync has reistered.</p>
<pre class="language-javascript"><code class="language-javascript">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./sw.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// register sync</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'requestButton'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      registration<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'image-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sync registered'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Unable to fetch image.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Unable to register Service Worker.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker functionality not supported.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>	
</code></pre>
<p>In most situations we can get away with using a build tool to generate the Service Worker. Workbox provides tutorials and code examples for Webpack, Gulp and using NPM scripts to generate the Service Worker. An example using gulp is shown below:</p>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'bundle-sw'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> wbBuild<span class="token punctuation">.</span><span class="token function">generateSW</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   globDirectory<span class="token operator">:</span> <span class="token string">'./_site/'</span><span class="token punctuation">,</span>
    swDest<span class="token operator">:</span> <span class="token string">'./_site/sw.js'</span><span class="token punctuation">,</span> 
    staticFileGlobs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**\/*.{html,js,css}'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    globIgnores<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sw.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    skipWaiting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// optional</span>
    clientsClaim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// optional</span>
 
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service worker generated.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[ERROR] '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>In the future we will be able to create periodic sync calls like this:</p>
<pre class="language-javasacript"><code class="language-javasacript">navigator.serviceWorker.ready.then(function(registration) {
  registration.periodicSync.register({
    tag: 'get-latest-news',         // default: ''
    minPeriod: 12 * 60 * 60 * 1000, // default: 0
    powerState: 'avoid-draining',   // default: 'auto'
    networkState: 'avoid-cellular'  // default: 'online'
  }).then(function(periodicSyncReg) {
    // success
  }, function() {
    // failure
  })
});
</code></pre>
<p>This will initiate a background sync every 12 hours but only if the</p>
<h2 id="service-worker-tooling-(the-old-way)">Service Worker Tooling (the old way)</h2>
<p>Doing it by hand is fun and teaches you a lot about the inner workings of service workers but having to update the files you want to cache and how to define the routes you want to use to cache your content.</p>
<p><a href="https://github.com/GoogleChrome/sw-precache/blob/master/GettingStarted.md">sw-precache</a> is a Google tool developed to atuomate creation of service workers with application shell caching on installation. The tool can be used from command line or as part of a build system (Grunt, Gulp and others).</p>
<p>It will also take care of importing additional scripts to use sw-toolbox (described in the next section).</p>
<p>A gulpfile.js using sw-precache looks like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Assigning modules to local constants</span>
<span class="token keyword">var</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Required for sw-precache</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> swPrecache <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sw-precache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Array of paths. Currently only uses the src to represent the path to source</span>
<span class="token keyword">var</span> paths <span class="token operator">=</span> <span class="token punctuation">{</span>
	src<span class="token operator">:</span> <span class="token string">'./'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'service-worker'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  swPrecache<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>src<span class="token punctuation">,</span> <span class="token string">'service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  staticFileGlobs<span class="token operator">:</span> <span class="token punctuation">[</span>
    paths<span class="token punctuation">.</span>src <span class="token operator">+</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
    paths<span class="token punctuation">.</span>src <span class="token operator">+</span> <span class="token string">'js/main.js'</span><span class="token punctuation">,</span>
    paths<span class="token punctuation">.</span>src <span class="token operator">+</span> <span class="token string">'css/main.css'</span><span class="token punctuation">,</span>
    paths<span class="token punctuation">.</span>src <span class="token operator">+</span> <span class="token string">'images/**/*'</span>
    
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    importScripts<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'node_modules/sw-toolbox/sw-toolbox.js'</span><span class="token punctuation">,</span>
      paths<span class="token punctuation">.</span>src <span class="token operator">+</span> <span class="token string">'js/toolbox-scripts.js'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    stripPrefix<span class="token operator">:</span> paths<span class="token punctuation">.</span>src
  <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><a href="https://googlechrome.github.io/sw-toolbox/docs/master/tutorial-usage">sw-toolbox</a> automates dynamic caching for your service worker. It creates customizable routes for your caching and provides for express-like or regular-expression-based routes to match routes and resources.</p>
<p>In the gulpfile.js above the <code>importScripts</code> section imports two files:</p>
<ul>
<li>sw-toolbox.js is the library that will run the custom routes</li>
<li>toolbox-scripts contains our custom toolbox routing</li>
</ul>
<p>The script itself is wrapped in an immediately-invoked function expression (IIFE) to keep our code from polluting the global namespace. Inside the IIFE we work with different routes.</p>
<p>All these routes use the get HTTP verb to represent the action the router will take.</p>
<p>The toolkbox then takes a pattern to match the route against and a cache strategy.</p>
<p>There is an optional cache object that contains additional parameters for the cache like (cache) name, maximum number of entries (maxEntries) and maximum duration of the cache in seconds.</p>
<p>The <code>toolbox-scripts.js</code> looks like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">// The route for any requests from the googleapis origin</span>
global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/(.*)'</span><span class="token punctuation">,</span> global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>cacheFirst<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  cache<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'googleapis'</span><span class="token punctuation">,</span>
    maxEntries<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  origin<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.googleapis\.com$</span><span class="token regex-delimiter">/</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// We want no more than 50 images in the cache. </span>
<span class="token comment">// We use a cache first strategy</span>
global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(?:png|gif|jpg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>cacheFirst<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  cache<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'images-cache'</span><span class="token punctuation">,</span>
    maxEntries<span class="token operator">:</span> <span class="token number">50</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// pull html content using network first</span>
global<span class="token punctuation">.</span><span class="token function">addEventListner</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'accept'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>toolbox<span class="token punctuation">.</span><span class="token function">networkFirst</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// you can add additional synchronous checks </span>
  <span class="token comment">// based on event.request.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// pull video using network only.</span>
global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'(.+)'</span><span class="token punctuation">,</span> global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>networkOnly<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  origin<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(?:youtube|vimeo)\.com$</span><span class="token regex-delimiter">/</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// the default route is global and uses cacheFirst</span>
global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">,</span> global<span class="token punctuation">.</span>toolbox<span class="token punctuation">.</span>cacheFirst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Registering the automatically generated service worker is no different than registering the manually generated script. Assuming that we saved the service worker as <code>sw.js</code> the registration code in our entry page (<code>index.html</code>) looks like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker is supported'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'sw.js'</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Yay!'</span><span class="token punctuation">,</span> reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'boo!'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="service-worker-tooling-(the-new-way)">Service Worker Tooling (the new way)</h2>
<p>Since I first wrote this essay, Google has updated the Service Worker librariess and consolidated them into one library called <a href="https://workboxjs.org">Workbox</a> and it has made all the separate libraries into modules of the larger workbox tool.</p>
<p>To achieve functionality equivalent to the old precache + sw-toolbox libraries we have to take a two step process:</p>
<p>First we write the Service Worker with all the routes that we need and a placeholder for the array of items we want to precache.</p>
<p>In the build file (gulpfile in this case) we add (or modify) the service worker build task will determine what files to precache and insert those in to the <code>workboxSW.precache</code> array that we left empty when creating the Service Worker.</p>
<h3 id="the-service-worker">The Service Worker</h3>
<p>The service worker does a few things.</p>
<ol>
<li>It imports the <code>workbox-sw</code> script using <code>importScripts</code></li>
<li>It sets up a constant to use when we reference the library</li>
<li>It creates a place holder for the array of items to precache</li>
<li>it creates and register routes for different items.</li>
</ol>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Alternatively, use your own local copy of workbox-sw</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://unpkg.com/workbox-sw@0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1</span>

<span class="token keyword">const</span> workboxSW <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">goog<span class="token punctuation">.</span>SWLib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token comment">// Pass in an empty array for our dev environment service worker.</span>
<span class="token comment">// Gulp will populate the array when we build the project</span>
workboxSW<span class="token punctuation">.</span><span class="token function">precache</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

<span class="token comment">// All navigation requests should be routed to the App Shell.</span>
<span class="token comment">// since we're not using app shell it's commented out</span>
<span class="token comment">// workboxSW.router.registerNavigationRoute('/');</span>

<span class="token comment">// Use a cache first strategy for files from googleapis.com</span>
workboxSW<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span> <span class="token comment">// 4</span>
  <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'.googleapis.com$'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  workboxSW<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    cacheName<span class="token operator">:</span> <span class="token string">'googleapis'</span><span class="token punctuation">,</span>
    cacheExpiration<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Expire after 3 days (expressed in seconds)</span>
      maxAgeSeconds<span class="token operator">:</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Use a cache-first strategy for the images</span>
workboxSW<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'/.(?:png|gif|jpg)$/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  workboxSW<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    cacheName<span class="token operator">:</span> <span class="token string">'images'</span><span class="token punctuation">,</span>
    cacheExpiration<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// maximum 50 entries</span>
      maxEntries<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
      <span class="token comment">// Expire after 30 days (expressed in seconds)</span>
      maxAgeSeconds<span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// The images are returned as opaque responses, </span>
    <span class="token comment">// with a status of 0.</span>
    <span class="token comment">// Normally these wouldn't be cached; </span>
    <span class="token comment">// here we opt-in to caching them.</span>
    <span class="token comment">// If the image returns a satus 200 we cache it too</span>
    cacheableResponse<span class="token operator">:</span> <span class="token punctuation">{</span>statuses<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Match all .html and .html files use cacheFirst</span>
<span class="token comment">// cache the resources for 24 hours </span>
workboxSW<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'/.html$|.htm$/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  workboxSW<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    cacheName<span class="token operator">:</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
    cacheExpiration<span class="token operator">:</span> <span class="token punctuation">{</span>
      maxAgeSeconds<span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// For video we use a network only strategy. </span>
<span class="token comment">// We don't want to clog the cache with large video files</span>
workboxSW<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'/.(?:youtube|vimeo).com$/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  workboxSW<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">networkOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The default route uses a cache first strategy</span>
workboxSW<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">,</span>
  workboxSW<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="the-build-file">The build file</h3>
<p>The new <code>service-worker</code> task changes from generating the full service worker to only injecting the manifest into the actual service worker file.</p>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'service-worker'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> workboxBuild<span class="token punctuation">.</span><span class="token function">injectManifest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    swSrc<span class="token operator">:</span> <span class="token string">'src/service-worker.js'</span><span class="token punctuation">,</span>
    swDest<span class="token operator">:</span> <span class="token string">'_site/service-worker.js'</span><span class="token punctuation">,</span>
    globDirectory<span class="token operator">:</span> <span class="token string">'_site'</span><span class="token punctuation">,</span>
    staticFileGlobs<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'rev/js/**/*.js'</span><span class="token punctuation">,</span>
      <span class="token string">'rev/styles/*.css'</span><span class="token punctuation">,</span>
      <span class="token string">'images/**/*'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="what-can-we-do-beyond-offline%3F">What can we do beyond offline?</h2>
<p>The service worker script we discussed in the prior section is the core of a PSP but there’s way more we can do to make our reading experiences behave more like native applications.  There are more things we can do that may or may not be fully related to Service Workers but they do gives us additional tools in the arsenal to work in crafting our reading experiences.</p>
<p>While not directly related to service workers this feature may help get better re-engagement from your users:</p>
<ul>
<li>Installation in mobile home screens</li>
</ul>
<p>Also not directly related to progressive web applications, we can also preserve data, not just content on our web applications using</p>
<ul>
<li>IndexedDB</li>
</ul>
<p>We’ll discuss them in the sections below.</p>
<h3 id="installation-in-mobile-home-screens">Installation in mobile home screens</h3>
<p>Using the <a href="https://www.w3.org/TR/appmanifest/">W3C App Manifest specification</a> and the existing metatags for adding an app to the homescreen in mobile devices we enable our users to add our web content to the homescreen of mobile devices to foster a higher level of interaction and reengagement with the content.</p>
<p>It’s next to impossible to remember all the items you can include in your manifest. Rather than go through tutorials for the reduced set required for Android’s add to homescreen (documented in <a href="https://developers.google.com/web/updates/2014/11/Support-for-installable-web-apps-with-webapp-manifest-in-chrome-38-for-Android">Google’s web fundamentals</a> we can use tools like Manifestation (either as a <a href="https://www.npmjs.com/package/manifestation">Node Package</a> or <a href="https://webmanife.st/">web based</a>) to generate a complete manifest for our applicaiton. The Node version can also be used as part of a Gulp/Grunt build system.</p>
<p><a href="http://html5doctor.com/web-manifest-specification/">HTML5 Doctor</a> has a good an up to date reference on App Manifest. Another source of information is the Mozilla Developer Network article on <a href="https://developer.mozilla.org/en-US/docs/Web/Manifest">Web App Manifest</a>.</p>
<p>Expect a deeper dive on Web Application Manifest some time in December.</p>
<h3 id="indexeddb">IndexedDB</h3>
<p>We’ve had client-side storage solutions for a while now. Sessions Storage, WebSQL and IndexedDB. Until recently they had no uniform support among brosers and one (WebSQL) is no longer being developed because all the implementations relied on <a href="https://sqlite.org/">SQLite</a> as the backend and this was considered to violate the “two interoperable implementations” requirements for W3C specs.</p>
<p>I’ve chosen IndexedDB as the engine to store data for my offline applications because, as complicated as the API is work with, there are wrapper libraries that make the work easier and will work across browsers, even Safari (which has a deserved reputation for shitty IndexDB implementations).</p>
<p>Knowing how much of a pain it can be to write bare IndexedDB code, I’ve picked <a href="http://dexie.org/">Dexie</a> as my wrapper library. It is easy to use and, for browsers who have issues with indexedDB like Safari, provide a transparent fallback to WebSQL.  It also uses promises rather than callbacks and, once you start working with promises, you will never go back to callbacks :-)</p>
<p>The example below shows how to create a database and a store for the a theoretical friends datastore.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dexie</span><span class="token punctuation">(</span><span class="token string">"friends"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a schema</span>
db<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stores</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  friends<span class="token operator">:</span> <span class="token string">'name, age'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>We then open the database</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Open the database</span>
db<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'database open'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Uh oh : '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>We can then insert records into the datastore one at a time or using a transaction.</p>
<p>Transactions group one or more actions into an atomic unit. If any of the actions composing a transaction fails then the entire transaction fails and the datasore is rolled back to the state before the transaction began.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Insert data into the database</span>
db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Camilla'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">25</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Insert data into database using transactions</span>
<span class="token keyword">function</span> <span class="token function">populateSomeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">"rw"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>friends<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">48</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Ylva"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Jon"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">76</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Måns"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">56</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">55</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Nils"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Zlatan"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">// Log data from DB:</span>
    db<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token parameter">friend</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We can then retrieve data from the store usning queries similar to the SQL syntax. An example of this query retrieves all the names from the data store where the age is over (above) 35 and then display the names.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Query friends datastore</span>
db<span class="token punctuation">.</span>friends
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">above</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">each</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">friend</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span> <span class="token punctuation">(</span>friend<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>There may be occasions when we need to delete the database, maybe because we don’t need it again or maybe because we screwed up and want to start over.</p>
<pre class="language-javascript"><code class="language-javascript">db<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Database successfully deleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Could not delete database"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do what should be done next...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This is a very broad and quick overview of Dexie. If you want more information check <a href="https://github.com/dfahlander/Dexie.js/wiki/Tutorial">the Dexie.js Tutorial</a> to get started.</p>
<p>There are other wrapper libraries for IndexedDB but Dexie is the most flexible and forgiving one for me.</p>
<h2 id="other-fun-things-we-can-do">Other fun things we can do</h2>
<h3 id="annotations">Annotations</h3>
<p>I still remember the first time I made an annotation from a Kindle book available in  their public site (<a href="http://kindle.amazon.com/">kindle.amazon.com</a>). I saw the possibilities as limitless until I realized that there were limitless as long as you bought the book from Amazon and read it on a Kindle device or application.</p>
<p>Every time I’ve turned around and searched for some way to annotate the web I’ve come with these two solutions but I’ve never had a project they work well with. I think PSPs are the perfect place to put this in practice. There are two libraries I think are particularly appropriate: <a href="https://github.com/NYTimes/Emphasis">Emphasis</a> and <a href="http://annotatorjs.org/">annotator.js</a> which provide different ways to make and share annotations from your PSPs.</p>
<p>Emphasis provides dynamic paragraph-specific anchor links and the ability to highlight text in a document, it makes the information about the highlighted elements of the page available in the URL hash so it can be emailed, bookmarked, or shared.</p>
<p>Annotator provides a more traditional annotation interface that is closer in spirit to the Kindle annotation UI that attracted me to the concept when I first saw it.</p>
<figure>
  <img src="http://annotatorjs.org/images/thumb-add.png" alt="" />
  <img src="http://annotatorjs.org/images/thumb-viewer.png" alt="" />
  <img src="http://annotatorjs.org/images/thumb-bookmarklet.png" alt="" />
</figure>
<p>Another tool that sounds interesting is MIT’s <a href="http://www.annotationstudio.org/">Annotation Studio</a> but it seems to be geared towards MIT Hyperstudio’s larger project and not necessarily ready as a standlone solution, that said, your milleage may vary.</p>
<p>The thing to consider if how these annotation tools store the annotations. Do they use server-side databases? If so how do we cache new annotations when the reader is offline? Google Analytics provides a possible example where we store the annotations in indexedDB and then play them back when the user goes online.</p>
<h2 id="structuring-and-styling-our-content">Structuring and styling our content</h2>
<p>We want our content to look awesome regardless of the device. How do we accomplish this?</p>
<p>A good starting point is Ethan Marcotte’s <a href="https://abookapart.com/products/responsive-web-design">Responsive Web Design</a> (or whatever Responsive Web Design book is your favorite). We want the experience to scale to whatever device or platform we’re targeting and, whatever design we choose, the first thing we need to make sure of is that it’ll work well in phones, tablets and desktops (in other words, everywhere there is a browser).</p>
<p>Once we have a layout we can start thinking about, what to me is, the most important part of any long form project: typography.  I’ve <a href="https://caraya.github.io/book-app/app/typography.html">written extensively</a> on what typography is and how it works on the web now we need to take the next steps.</p>
<p>This is where the first set of choices happen: What layout do we choose? How do we create something engaging without becoming repetitive? How do we craft a reading experience that matches the content?</p>
<div class="video">
<iframe width="560" height="315" src="https://www.youtube.com/embed/kRYrbcGWjzU?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
<p>I first saw Jen’s presentation at SFHTML5. I see it as a challenge and an opportunity to think differently about the way we create and layout our content on the web.  For longer form content this also speaks to letting the content dictate the layout and not the other way around.  What is it that makes magazine layouts so interesting?</p>
<p>I collect electronic versions of GQ, Wired, Vanity Fair, Fast Company and Harvard Business Review and the biggest question when I read them is how can we make this reading experience in the open web? The ads from magazines are what intrigue me the most… and where a lot of my most radical ideas come from.</p>
<div class="video">
<iframe src="https://player.vimeo.com/video/112865159?color=9c191e" width="560" height="315" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
</div>
<p>After watching this presentation from Beyond Tellerand I couldn’t help reading the new edition of <a href="https://shop.smashingmagazine.com/products/hardboiled-web-design">Hardboiled Web Design</a>. Clarke advocates that creativity should be at the center of our online design work… It speaks to the need of art directed web design and bespoke designs rather than using the same design over and over.</p>
<p>If we drop the book metahphor from our online reading experiences, There is no limit to what we can do with our online publications.   We need to go back to our content and see how we can enrich it and what technologies we can use to do so… we have a lot of layout tools that, a few years ago, were only possible in InDesign and other Desktop Publishing Tools or took a lot of extra workarounds to do in CSS/HTML/JavaScript.</p>
<p>Now we need to get out our collective comfort zone and challenge both ourselves and our future readers with layouts that go beyond what we see on the web today.</p>
<p>One last example of what we can do with our new css tools and how much we can be true to our creative selves without having to lie to our web developer selves: Justin McDowell uses new CSS technologies to recreate works from the Bauhaus school.</p>
<div class='video'>
<iframe width="560" height="315" src="https://www.youtube.com/embed/I49NX1C8qt8" frameborder="0" allowfullscreen></iframe>
</div>
<h2 id="how-have-reader-expectations-changed%3F-(ui-for-the-performance-obsessed)">How have reader expectations changed? (UI for the performance obsessed)</h2>
<p>As consumers of information we’ve all become more demanding. We want the content faster and we want to be engaged with the content we access online. PSPs should be no different in their performance than traditional web applications.</p>
<p>Rather than provide a one-size-fits-all solution I present some of the data Nielsen first articulated in 1993’s <em>Usability Engineering</em> We’ll use these values to draw some basic conclusions that will start the thinking about performance and how PSPs can work towards achieving those performance goals.</p>
<ul>
  <li><strong>0.1 seconds</strong> — Operations that are completed in 100ms or fewer will feel instantaneous to the user. This is the gold standard that you should aim for when optimising your websites.</li>
  <li><strong>1 second</strong> — Operations that take 1 second to finish are generally OK, but the user will feel the pause. If all of your operations take 1 second to complete, your website may feel a little sluggish.</li>
  <li><strong>10 seconds</strong> — If an operation takes 10 seconds or more to complete, you’ll struggle to maintain the user’s attention. They may switch over to a new tab, or give up on your website completely. Of course this depends on what operation is being completed. For example, users are more likely to stick around if they’ve just submitted their card details in the checkout than if they’re waiting to load a product page.</li>
  <li><strong>16 milliseconds</strong> — Given a screen that is updating 60 times per second, this window represents the time to get a single frame to the screen (1000 ÷ 60 = ~16). People are exceptionally good at tracking motion, and they dislike it when their expectation of motion isn’t met, either through variable frame rates or periodic halting.</li>
</ul>
<p>We want to get to the site’s first meaningful paint on initial load in as close to 1000 milliseconds as possible.</p>
<p>Animations should take no more than 16 milliseconds in order to reach 60 frames a second.</p>
<h2 id="performance-optimizations">Performance Optimizations</h2>
<p>We can optimize our resources so that time to first meaningful interaction is as short as possible. First load will also cache the resources needed for our application shell and then dynamically .  We want to optimize this to last as little as possible.</p>
<p>This is not just speech for the sake of speach. Take the following graphic (from Soasta’s <a href="https://www.soasta.com/blog/page-bloat-average-web-page-2-mb/">Page bloat update: The average web page is more than 2 MB in size</a>).  How can we minimize the number of resources to load and cache the first time we access a page? How many of these resources can be reused on pages accross the site? How can we optimize images to reduce their size?</p>
<figure>
  <img src="https://www.soasta.com/wp-content/uploads/2015/06/page-bloat-images.png" alt="" width="75%" />
</figure>
<p>We have gotten lazy or, possibly, made the wrong assumptions. The graphic below, also from Soasta’s blog post, show how the size of our web content has changed over the years… and it shows no signs of decreasing.</p>
<figure>
  <img src="https://www.soasta.com/wp-content/uploads/2015/06/page-bloat-May15-page-composition.png" alt="" width="75%" />
</figure>
<p>I’ve added an image compression step to my build file based <a href="https://www.npmjs.com/package/gulp-imagemin">gulp-imagemin</a> to make sure that I reduce the size of the images on my apps and sites. The Gulp plugin comes bundled with the following <strong>losless</strong> compression tools</p>
<ul>
<li><a href="https://github.com/imagemin/imagemin-gifsicle">gifsicle</a> — Compress GIF images</li>
<li><a href="https://github.com/imagemin/imagemin-jpegtran">jpegtran</a> — Compress JPEG images</li>
<li><a href="https://github.com/imagemin/imagemin-optipng">optipng</a> — Compress PNG images</li>
<li><a href="https://github.com/imagemin/imagemin-svgo">svgo</a> — Compress SVG images</li>
</ul>
<p>The actual Gulp task looks is this:</p>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'imagemin'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/images/originals/**'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      progressive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      svgoPlugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>removeViewBox<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>cleanupIDs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">mozjpeg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'src/images'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      pretty<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      title<span class="token operator">:</span> <span class="token string">'imagemin'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>As usual, your mileage may vary.</p>
<h2 id="how-are-you-serving-your-content%3F">How are you serving your content?</h2>
<p>PSPs do not avoid performance requirements… however the questions are slightly different. Are you serving your content with HTTP 1.x or HTTP2? When I first heard the question asked I laughed… why should this matter?</p>
<p>HTTP2 has changed the way we work with web content. What we used to consider as patterns and best practices are no longer necessay and may be considered anti patterns.</p>
<p>Because of the way HTTP2 serves the content it is not necessary to concatenate our CSS and Javascript, it actually work better if you work with individual minimized files; HTTP2:</p>
<ul>
<li>is binary, instead of textual: Binary protocols are more efficient to parse, more compact “on the wire”, and most importantly, they are much less error-prone, compared to textual protocols like HTTP/1.x, because they often have a number of affordances to “help” with things like whitespace handling, capitalization, line endings, blank lines and so on</li>
<li>is fully multiplexed: Multiplexing addresses <a href="https://www.wikiwand.com/en/Head-of-line_blocking">head-of-line-blocking</a> by allowing multiple request and response messages to be in flight at the same time; it’s even possible to intermingle parts of one message with another on the wire</li>
<li>can use one connection for parallelism: One application opening many connections simultaneously breaks a lot of the assumptions that TCP was built upon; since each connection will start a flood of data in the response, there’s a real risk that buffers in the intervening network will overflow, causing a congestion event and retransmits</li>
<li>uses header compression to reduce overhead:  If you assume that a page has about 80 assets and each request has 1400 bytes of headers, it takes at least 7-8 round trips to get the headers out “on the wire”. In comparison, even mild compression on headers allows those requests to get onto the wire within one round trip – perhaps even one packet.</li>
<li>allows servers to “push” responses proactively into client caches: When the server pushes the content that the client will need before it needs it we can save networks requests by caching the content in the browser (HTTP) cache</li>
</ul>
<p>This doesn’t mean we shouldn’t minimize and compress resources but bundling them together is less important now that we don’t have to be concerned with saturating the connection to the server and can leverage HTTP2 push to let the server prefetch content to the client.</p>
<p>Improving performance is a never ending game. Ilya Grigorik illustrates this point in his presentation from I/O 2016.</p>
<div class="video">
<iframe width="560" height="315" src="https://www.youtube.com/embed/aqvz5Oqs238?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
<h1 id="what-can-we-build">What can we build</h1>
<p>So far we’ve discussed how to build a progressive subcompact publications. We have a good technology stack of APIs and technologies that make our publications responsive so we only need one codebase for multiple devices, have diverse capabilities such as data visualizations, 2D and 3D virtual reality and many others.</p>
<p>At the same time we can control more and more of the intangibles and the tangibles outlined by Massimo Vignelly in the <a href="http://www.vignelli.com/canon.pdf">Vignelli Cannon</a>.</p>
<table>
  <thead>
    <tr>
      <th>The Intangibles</th>
      <th>The Tangibles
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <ul>
          <li>Semantics</li>
          <li>Syntactics</li>
          <li>Pragmatics</li>
          <li>Discipline</li>
          <li>Appropriateness</li>
          <li>Ambiguity</li>
          <li>Design is One</li>
          <li>Visual Power</li>
          <li>Intellectual Elegance</li>
          <li>Timelessness</li>
          <li>Responsibility</li>
          <li>Equity</li>
        </ul>   
      </td>
      <td>
        <ul>
          <li>Paper Sizes</li>
          <li>Grids, Margins, Columns and Modules</li>
          <li>A Company Letterhead</li>
          <li>Grids for Books</li>
          <li>Typefaces, The Basic Ones</li>
          <li>Flush left, centered, justified</li>
          <li>Type Size Relationships</li>
          <li>Rulers</li>
          <li>Contrasting Type Sizes</li>
          <li>Scale</li>
          <li>Texture</li>
          <li>Color</li>
          <li>Layouts</li>
          <li>Sequence</li>
          <li>Binding</li>
          <li>Indentity and Diversity</li>
          <li>White Space</li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<p>Those that we can’t control we can work around, for example rather than worrying about paper size we can worry about different layouts depending on the screen size available to you.</p>
<p>This doesn’t mean we want the same layout for the web that we want for print. We’re closer to it with the introduction of CSS Grid in early 2017 and creative uses of existing content like those in Jen Simmons’ <a href="http://labs.jensimmons.com/2016/">Lab</a> but we’re not completely there yet.</p>
<p>Now that we’ve gotten an idea of where we’re going we’ll discuss what we can do and provide ideas and examples of what we can use PSPs for.</p>
<h2 id="resilient-web-design">Resilient Web Design</h2>
<p>Jeremy Keith’s <a href="https://resilientwebdesign.com/">Resilient Web Design</a> provides a basic idea of what we can do with PSP and PSP-like applications can do. We go to the website and, if it support service workers, will pre-cache the content of the site (the ecomplete HTML content and the associated CSS And Javascript) and store it in the browser so we can view the content regardless of network connectivity.</p>
<p>The book is responsive so it’ll work regardless of what form factor you use to view it and, in mobile devices, you can save it to the home screen in a mobile device or a shelf in Chrome for desktop.</p>
<h1 id="links%2C-resources%2C-patterns-and-ideas">Links, resources, patterns and ideas</h1>
<ul>
<li>Responsive Web Design
<ul>
<li><a href="https://abookapart.com/products/responsive-web-design">Responsive Web Design</a> — Ethan Marcotte, A Book Apart</li>
<li><a href="https://abookapart.com/products/responsible-responsive-design">Responsible Responsive Design</a> — Scott Jehl, A Book Apart</li>
<li><a href="https://abookapart.com/products/going-responsive">Going Responsive</a> — Karen McGrane, A Book Apart</li>
<li><a href="https://abookapart.com/products/responsive-design-patterns-principles">Responsive Design: Patterns and Principles</a> — Ethan Marcotte, A Book Apart</li>
<li><a href="https://abookapart.com/products/design-for-real-life">Design For Real Life</a> — Eric Mayer &amp; Sara Wachter-Boettcher, A Book Apart</li>
<li><a href="https://www.smashingmagazine.com/books/#inclusive-design-patterns">Inclusive Design Patterns</a> — Haydon Pickering, Smashing Books</li>
</ul>
</li>
<li>Service Workers
<ul>
<li><a href="http://caniuse.com/#feat=serviceworkers">caniuse.com support matrix</a></li>
<li><a href="https://w3c.github.io/ServiceWorker/">Specification</a></li>
<li><a href="https://jakearchibald.github.io/isserviceworkerready/resources.html">Is ServiceWorker ready?</a> — Jake Archibald</li>
<li><a href="https://developers.google.com/web/fundamentals/getting-started/primers/service-workers">Service Workers: an Introduction</a> — Web Fundamentals</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Worker API</a> — MDN</li>
<li>Support by browsers
<ul>
<li><a href="https://developer.microsoft.com/en-us/microsoft-edge/platform/status/serviceworker/">MS Edge</a></li>
<li><a href="https://webkit.org/status/#specification-service-workers">WebKit - Safari</a></li>
<li><a href="https://platform-status.mozilla.org/#service-worker">Firefox</a></li>
<li><a href="https://www.chromestatus.com/feature/6561526227927040">Chrome / Opera</a></li>
</ul>
</li>
<li>Background Sync
<ul>
<li><a href="https://github.com/WICG/BackgroundSync/blob/master/explainer.md">Background synchronization explained</a></li>
</ul>
</li>
</ul>
</li>
<li>Accessibility
<ul>
<li><a href="http://a11yproject.com/">A11y Project</a></li>
<li>Chrome <a href="accessibility-developer-tools">Accessibility Developer Tools</a></li>
<li><a href="https://www.w3.org/TR/appmanifest/">A11y accessibility checker</a></li>
<li><a href="https://webaccessibility.withgoogle.com/course">Introduction to web accessibility course</a> — Google</li>
<li><a href="https://www.smashingmagazine.com/2014/07/the-wai-forward/">The WAI Forward</a> — Heydon Pickering, Smashing Magazine</li>
<li><a href="https://www.paciellogroup.com/resources/contrastanalyser/">Colour Contrast Analyser</a>— The Paciello Group</li>
<li><a href="https://www.paciellogroup.com/blog/2014/10/accessibility-testing-tools-updated/">Accessibility Testing Tools Updated</a> — The Paciello Group</li>
</ul>
</li>
<li>Service Worker related
<ul>
<li>Web Push Notifications
<ul>
<li><a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/">Web Push Notifications: Timely, Relevant, and Precise</a> — Web Fundamentals</li>
<li><a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/good-notification">What Makes a Good Notification?</a></li>
<li><a href="https://www.youtube.com/watch?v=_dXBibRO0SM&amp;ab_channel=GoogleChromeDevelopers">Video: Web Push Notifications</a> — Google I/O 2016</li>
<li><a href="https://www.youtube.com/watch?v=HbmcnjWFGbY&amp;ab_channel=@Scale">Bringing Push Notifications to the Mobile Web</a> — @scale</li>
<li><a href="https://www.youtube.com/watch?v=Zq-tRtBN3ws&amp;ab_channel=GoogleChromeDevelopers">Deep Engagment with Push Notifications</a> — Progressive Web App Summit 2016</li>
</ul>
</li>
<li>Installation on mobile home screen
<ul>
<li><a href="https://developer.chrome.com/multidevice/android/installtohomescreen">Add to homescreen</a> — Android</li>
<li><a href="https://developers.google.com/web/fundamentals/engage-and-retain/app-install-banners/?hl=en">Web App Install Banners</a> — Chrome for Android</li>
<li><a href="https://developers.google.com/web/updates/2015/03/increasing-engagement-with-app-install-banners-in-chrome-for-android">Increasing Engagement with Web App Install Banners</a> — Chrome for Android</li>
<li><a href="https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html">Configuring Web Applications</a> — iOS</li>
<li><a href="http://html5doctor.com/web-manifest-specification/">Web manifest specification</a> — HTML5 Doctor</li>
</ul>
</li>
</ul>
</li>
<li>Peformance
<ul>
<li>General Readings
<ul>
<li><a href="https://hpbn.co/">High Performance Browser Networking</a> — Ilya Grigorik, O’Reilly</li>
<li><a href="http://www.oreilly.com/webops-perf/free/web-performance-warrior.csp">Web Performance Warrior: The business of speed</a> - Andy Still, O’Reilly</li>
</ul>
</li>
<li>Performance Patterns
<ul>
<li><a href="https://www.smashingmagazine.com/2015/10/rail-user-centric-model-performance/">Introducing RAIL: A User-Centric Model For Performance</a></li>
<li><a href="https://www.polymer-project.org/1.0/toolbox/server">Serve your content</a> (introduces the PRPL pattern)</li>
</ul>
</li>
<li>HTTP2
<ul>
<li><a href="https://hpbn.co/http2/">High Performance Browser Networking, chapter 12</a> — Ilya Grigorik, O’Reilly</li>
<li><a href="https://blogs.akamai.com/2016/04/are-you-ready-for-http2-server-push.html">Are you ready for HTTP/2 Server Push?!</a>  — Akhil Jayaprakash</li>
<li><a href="https://www.igvita.com/2013/06/12/innovating-with-http-2.0-server-push/">Innovating with HTTP2 server push</a> — Ilya Grigorik</li>
</ul>
</li>
</ul>
</li>
<li>Readings
<ul>
<li><a href="http://alistapart.com/article/performance-showing-versus-telling">Performance: Showing Versus Telling</a> — Lara Hogan</li>
<li><a href="http://blog.teamtreehouse.com/perceived-performance">An Introduction to perceived performance</a> — Matt West</li>
<li><a href="https://www.nngroup.com/articles/response-times-3-important-limits/">Response Times: The 3 Important Limits</a> — Jakob Nielsen</li>
<li><a href="https://www.nngroup.com/articles/powers-of-10-time-scales-in-ux/">Powers of 10: Time Scales in User Experience</a> — Jakob Nielsen</li>
<li><a href="http://theixdlibrary.com/pdf/Miller1968.pdf">Response time in man-computer conversational transactions</a> — Robert Miller</li>
<li><a href="http://www2.parc.com/istl/groups/uir/publications/items/UIR-1991-01-Card-CHI91-IV.pdf">The information visualizer: An information workspace</a> — Card, Robertson and Mackinlay</li>
<li><a href="http://dev.mobify.com/blog/beginners-guide-to-perceived-performance/">A Beginner’s Guide to Perceived Performance: 4 Ways to Make Your Mobile Site Feel Like a Native App</a> — Kyle Peatt</li>
<li><a href="http://sighci.org/uploads/published_papers/bit04/BIT_Nah.pdf">A Study on Tolerable Waiting Time: How long Are Web Users Willing to Wait?</a>— Fiona Fui-Hoon Nah</li>
<li><a href="http://www.interruptions.net/literature/Oulasvirta-CHI05-p919-oulasvirta.pdf">Interaction in 4-Second Bursts: The Fragmented Nature of Attentional Resources in Mobile HCI</a>— Antti Oulasvirta, Sakari Tamminen, Virpi Roto, and Jaana Kuorelaht</li>
<li><a href="http://isr.cmu.edu/doc/tolia06-ieee.pdf">Quantifying Interactive User Experience on Thin Clients</a>— Niraj Tolia, David G. Andersen, and M. Satyanarayanan</li>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.366.1170&amp;rep=rep1&amp;type=pdf">Characterizing Web Use on Smartphones</a>— Chad C. Tossell, Philip Kortum, Ahmad Rahmati, Clayton Shepard, Lin Zhong</li>
<li><a href="http://link.springer.com/chapter/10.1007%2F978-3-642-23771-3_42">Playing With Tactile Feedback Latency in Touchscreen Interaction: Two Approaches</a>— Topi Kaaresoja, Eve Hoggan, Emilia Anttila</li>
</ul>
</li>
</ul>
