<h1 id="customizing-markdown-it" tabindex="-1">Customizing Markdown-it</h1>
<p>In the <a href="https://publishing-project.rivendellweb.net/getting-markdown-plugins-to-work-with-gulp/">last post</a> we modified a Gulp workflow to include Markdown-it directly. But there are parts that can’t be done with plugins and are not part of the Markdown-It API.</p>
<p>This post will explore some of the customizations I’ve done with the Markdown-It API.</p>
<h2 id="manipulating-images%3A-adding-the-loading-attribute" tabindex="-1">Manipulating images: adding the loading attribute</h2>
<p>The first example is a simple one. We will add the <code>loading=&quot;lazy&quot;</code> attribute to all images so that browsers that support native lazy loading will use the feature and only load the image when it’s about to appear in the viewport or already in the viewport.</p>
<pre class="language-js"><code class="language-js">md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> slf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  token<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>token<span class="token punctuation">.</span><span class="token function">attrIndex</span><span class="token punctuation">(</span><span class="token string">'alt'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> slf<span class="token punctuation">.</span><span class="token function">renderInlineAsText</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>children<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  token<span class="token punctuation">.</span><span class="token function">attrSet</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span> <span class="token string">'lazy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> slf<span class="token punctuation">.</span><span class="token function">renderToken</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Just by adding this attribute we’ve made lazy loading images the default behavior. Other than images that appear in above the fold when the page loads, all other images will load only when they appear in the viewport.</p>
<h2 id="adding-attributes-to-links" tabindex="-1">Adding attributes to links</h2>
<p>Add <code>rel=&quot;noopener norefeerrer&quot;</code> attributes to links for SEO purposes</p>
<p>The final format should be <code>&lt;a href=&quot;https://example.com/&quot;  rel=&quot;noopener noreferrer&quot;&gt;Example Link&lt;/a&gt;</code>.</p>
<p>Using the <code>noopener</code> tells the browser to open a link in a new tab without providing backdoor access to the webpage that opened the link. This is achieved by not setting the <code>window.opener</code> property thus returning a null value.</p>
<p><code>noreferrer</code> will hide referrer information when the link is clicked. For example, if links to your post from their webpage and use the noreferrer, and then users click on that link, you will not be able to tell where did those users come from. In your analytics software (say, Google Analytics), this will appear as direct traffic, not as a referral.</p>
<p>There is an additional attribute that I chose not to use.</p>
<p>In general, when one page links to yours, it adds credibility to your site and signals to search engines that they value your website. If a high authority webpage links to you it is endorsing you, and Google/Bing will consider the endorsement a ranking factor. Google uses the term PageRank as a measure of quantity and quality of links.</p>
<p>Adding <code>nofollow</code> signals search engines that you don’t want to pass your ‘endorsement’ to the page you are linking to.</p>
<p>See <a href="https://pointjupiter.com/what-noopener-noreferrer-nofollow-explained/">Explained: noopener, noreferrer, and nofollow Values</a> for more information.</p>
<p>The code joins the existing attributes for the link with the new rel=“noopener noreferrer” attribute.</p>
<pre class="language-js"><code class="language-js">defaultLinkOpenRenderer <span class="token operator">=</span> md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>link_open <span class="token operator">||</span> proxy<span class="token punctuation">;</span>

md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">link_open</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">attrJoin</span><span class="token punctuation">(</span><span class="token string">"rel"</span><span class="token punctuation">,</span> <span class="token string">"noopener noreferrer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">defaultLinkOpenRenderer</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="adding-classes-to-list-and-list-items" tabindex="-1">Adding classes to list and list items</h2>
<p>There are a few things that I like doing with lists. Instead of trying to add attribute after attribute to control styles, I pass one or more classes to either the list itself of individual list items.</p>
<p>The first example adds a class attribute to the ordered (bulleted list). This could be used to change the numbering schema used on the list or style the list itself.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">proxy</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token operator">=></span> self<span class="token punctuation">.</span><span class="token function">renderToken</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> defaultOrderedListOpenRenderer <span class="token operator">=</span> md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>ordered_list_open <span class="token operator">||</span> proxy<span class="token punctuation">;</span>

md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">ordered_list_open</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">attrJoin</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">,</span> <span class="token string">"sample-class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">defaultOrderedListOpenRenderer</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>The second example styles list items. This is an all or nothing proposition. Either all list items get the class or none of them. Since the styles for bulleted and ordered list are differents the class shouldn’t have an effect where we don’t want it to, it just adds unnecessary bytes to the page</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">proxy</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token operator">=></span> self<span class="token punctuation">.</span><span class="token function">renderToken</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> defaultListItemOpenRenderer <span class="token operator">=</span> md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>list_item_open <span class="token operator">||</span> proxy<span class="token punctuation">;</span>

md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">list_item_open</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">attrJoin</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">,</span> <span class="token string">"decimal-zero-padded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">defaultListItemOpenRenderer</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>We’re using lists as an example. We could use a similar technique with other elements like tables, and paragraphs.</p>
<h2 id="wrapping-images-in-figure-elements" tabindex="-1">Wrapping images in figure elements</h2>
<p>The hardest one of these extensions is wrapping images in figure elements.</p>
<p>The first pass is easy enough, although it is also misleading since it doesn’t do exactly what we want.</p>
<p>The first version of this task, wraps the image in a <code>figure</code> element as part of the return statement.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> md <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> slf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
  token<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>token<span class="token punctuation">.</span><span class="token function">attrIndex</span><span class="token punctuation">(</span><span class="token string">'alt'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> slf<span class="token punctuation">.</span><span class="token function">renderInlineAsText</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>children<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">)</span>
  token<span class="token punctuation">.</span><span class="token function">attrSet</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span> <span class="token string">'lazy'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;figure>
  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>slf<span class="token punctuation">.</span><span class="token function">renderToken</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
  &lt;figcaption></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>token<span class="token punctuation">.</span><span class="token function">attrIndex</span><span class="token punctuation">(</span><span class="token string">'alt'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/figcaption>
&lt;/figure></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre>
<p>The surprise is that Markdown (both the original documents and the current Commonmark specification) consider images to be inline elements, rather than elements that can be either block or inline (like smileys or image emojis).</p>
<p>As a result, the parser wraps the image in a <code>p</code> element.</p>
<p>So the next, and significantly harder task, is to remove the paragraphs and replace them with a <code>figure</code> element, which is sematically more appropriate than a paragraph.</p>
<p>At the same time, it would be nice if we could add a cpation to the image using the <code>figcaption</code> element.</p>
<h2 id="wrapping-images-in-figure-elements-(version-2)" tabindex="-1">Wrapping images in figure elements (Version 2)</h2>
<p>The second version of this code is a bit more complicated.</p>
<p>In addition to the lazy loading attribute, it takes the value of the <code>alt</code> attribute and uses it as the caption for the image</p>
<pre class="language-js"><code class="language-js">md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> slf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
  token<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>token<span class="token punctuation">.</span><span class="token function">attrIndex</span><span class="token punctuation">(</span><span class="token string">'alt'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> slf<span class="token punctuation">.</span><span class="token function">renderInlineAsText</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>children<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">)</span>
  token<span class="token punctuation">.</span><span class="token function">attrSet</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span> <span class="token string">'lazy'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;figure>
  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>slf<span class="token punctuation">.</span><span class="token function">renderToken</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
  &lt;figcaption></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>token<span class="token punctuation">.</span><span class="token function">attrIndex</span><span class="token punctuation">(</span><span class="token string">'alt'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/figcaption>
&lt;/figure></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre>
<p>It will produce the following HTML code:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>figure</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>demo.png<span class="token punctuation">"</span></span> 
    <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>demo<span class="token punctuation">"</span></span>
    <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>figcaption</span><span class="token punctuation">></span></span>demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>figcaption</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>figure</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
</code></pre>
<p>It still doesn’t get rid of the paragraphs, still working on figuring out how to do the replacement but, as it is, it works well enough without requiring a plugin.</p>
<h2 id="wrapping-images-in-figure-elements-using-a-third-party-plugin-(take-1)" tabindex="-1">Wrapping images in figure elements using a third party plugin (take 1)</h2>
<p>I haven’t been able to find a way to remove the paragraph container around the image. When I was about ready to give up I came across a pointer to the <a href="https://www.npmjs.com/package/markdown-it-custom-block">markdown-it-custom-block</a> plugin that lets me do exactly what I want and then some.</p>
<p>The original code using the plugin looks like this</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it-custom-block'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

md<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">img</span><span class="token punctuation">(</span><span class="token parameter">raw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>index<span class="token punctuation">,</span> alt<span class="token punctuation">,</span> width<span class="token punctuation">,</span> url<span class="token punctuation">]</span> <span class="token operator">=</span> raw<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;figure id="fig</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">
  &lt;img width='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" alt="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>alt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">
  &lt;figcaption>Fig </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>alt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/figcaption>
&lt;/figure></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The Markdown for the image is more complicated. It is a list of four attributes separated by <code>#</code> characters representing:</p>
<ul>
<li>The index (position of the image on the page)</li>
<li>The alt text displayed when the image is not loaded and also used as the figure caption</li>
<li>The width of the image</li>
<li>The full path to the image file</li>
</ul>
<pre class="language-markdown"><code class="language-markdown">@[img](1#Sample alt content will also be used for captions#400px#./images/demo.webp)
</code></pre>
<p>This is more complicated than it needs to be, but it works.</p>
<h2 id="wrapping-images-in-figure-elements-using-a-third-party-plugin-(take-2)" tabindex="-1">Wrapping images in figure elements using a third party plugin (take 2)</h2>
<p>One of the first things I thought about was removing the index and letting CSS take care of the indexing for us. Hardcoding the index in Markdown is a bad idea. If we insert images then all the indexes change and we need to edit every single image to compensate.</p>
<p>Using CSS generated content we can automate the indexing and generation of the <code>Figure &lt;id&gt;:</code> content in the captions:</p>
<pre class="language-css"><code class="language-css"><span class="token selector">article</span> <span class="token punctuation">{</span>
  <span class="token property">counter-reset</span><span class="token punctuation">:</span> figures<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">figure</span> <span class="token punctuation">{</span>
  <span class="token property">counter-increment</span><span class="token punctuation">:</span> figures<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">figure figcaption:before</span> <span class="token punctuation">{</span>
  <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">"Fig. "</span> <span class="token function">counter</span><span class="token punctuation">(</span>figures<span class="token punctuation">)</span> <span class="token string">": "</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And it does what I set out to do, eliminate the paragraphs around images and use figures instead.</p>
<p>So now the final version of our image code is:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'markdown-it-custom-block'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

md<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">img</span><span class="token punctuation">(</span><span class="token parameter">raw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>
      alt<span class="token punctuation">,</span>
      width<span class="token punctuation">,</span>
      url<span class="token punctuation">]</span> <span class="token operator">=</span> raw<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;figure>
  &lt;img width='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" alt="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>alt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">
  &lt;figcaption></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>alt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/figcaption>
&lt;/figure></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And the required Markdown changes accordingly:</p>
<pre class="language-markdown"><code class="language-markdown">@[img](Sample alt content will also be used for captions#400px#./images/demo.webp)
</code></pre>
