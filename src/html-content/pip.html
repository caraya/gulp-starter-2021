<h1>PiP on the web</h1>
<p>I love listening to music in the background or having a video play while I’m doing something else, something like what iTunes does when you minimize the app.</p>
<p>There is an API that allows you to do somethng similar. The Picture in Picture API is currently <a href="https://github.com/WICG/picture-in-picture">under incubation</a> in the <a href="https://wicg.io/">Web Incubation Community Group</a> and an (incomplete) implementation available in Chrome since version 70 (behind the the <code>chrome://flags/#enable-surfaces-for-videos</code> flag) and Opera since version 57 (behind the the <code>opera://flags/#enable-surfaces-for-videos</code> flag).</p>
<p>The HTML document looks like any other video. We use the <code>playsinline</code> attribute to make sure it won’t go to fullscreen in iOS devices.</p>
<p>We also add a button to trigger the picture in picture process.</p>
<pre><code class="language-html">&lt;video id=&quot;video&quot;
    controls
    playsinline
    src=&quot;video/short.mp4&quot;
    poster=&quot;video/artwork-512.png&quot;&gt;&lt;/video&gt;
&lt;button id=&quot;togglePipButton&quot;&gt;Toggle Picture-in-Picture&lt;/button&gt;
</code></pre>
<p>Since the code is promise based so we can either use raw promises or async/await code. In most circumstances I’d go with raw promises since it gives me slightly better browser support but, since the feature is brand new we don’t have to worry about browser support anyways… so async/await it is. :)</p>
<p>The code is broken down into three events and an auxiliary function. The first function is a click event handler in the button.</p>
<p>We disable the toggle button while we wait for the actions to happen.</p>
<p>in the try block we test if the video is already in the picture in picture window. If it is not then we add it to the PiP window and if it is (meaning the video is already playing in the PiP window) we remove it.</p>
<p>In the catch block we log an error to console.</p>
<p>In the finally block we re-enable the PiP button. This will happen regardless of how we got to the finally block.</p>
<pre><code class="language-js">let pipWindow;

togglePipButton.addEventListener('click', async function(event) {
  console.log('Toggling Picture-in-Picture...');
  togglePipButton.disabled = true;
  try {
    if (video !== document.pictureInPictureElement)
      await video.requestPictureInPicture();
    else await document.exitPictureInPicture();
  } catch (error) {
    console.log(`I'm sorry David, I can't do that: ${error}`);
  } finally {
    togglePipButton.disabled = false;
  }
});
</code></pre>
<p>The next two events are picture-in-picture related; Once for when the video enters the picture in picture window and the other for when the video is removed from the PiP window.</p>
<p>The event sets <code>onPipWindowResize</code> as the resize event handler.</p>
<pre><code class="language-js">video.addEventListener('enterpictureinpicture', function(event) {
  console.log('Video Playing in Picture-in-Picture');

  pipWindow = event.pictureInPictureWindow;
  console.log(`The new window size is
    ${pipWindow.width}x${pipWindow.height}`);

  pipWindow.addEventListener('resize', onPipWindowResize);
});
</code></pre>
<p>The <code>leavepictureinpicture</code> notifies when the video is removed from the PiP window and retakes the original position.</p>
<p>The event removes <code>onPipWindowResize</code> as the resize event handler since we no longer need it.</p>
<pre><code class="language-js">video.addEventListener('leavepictureinpicture', function(event) {
  console.log('Exiting Picture-in-Picture');

  pipWindow.removeEventListener('resize', onPipWindowResize);
});
</code></pre>
<p><code>onPipWindowResize</code> is the function that will get called when the PiP window is resized. In this example we just log the new window size to the console.</p>
<pre><code class="language-js">function onPipWindowResize(event) {
  console.log(
    `New window size:
    ${pipWindow.width}x${pipWindow.height}`,
  );
}
</code></pre>
<p>The final portion of the script is to enable the button.</p>
<pre><code class="language-js">if ('pictureInPictureEnabled' in document) {
  setPipButton();
  video.addEventListener('loadedmetadata', setPipButton);
  video.addEventListener('emptied', setPipButton);
} else {
  togglePipButton.hidden = true;
}

function setPipButton() {
  togglePipButton.disabled =
    video.readyState === 0 ||
    !document.pictureInPictureEnabled ||
    video.disablePictureInPicture;
}
</code></pre>
<h2>Links and Resources</h2>
<ul>
<li><a href="https://github.com/WICG/picture-in-picture/blob/master/explainer.md">Picture in Picture Explainer</a></li>
<li><a href="https://googlechrome.github.io/samples/picture-in-picture/">Chrome Example</a></li>
<li><a href="https://github.com/googlechrome/samples/tree/gh-pages/picture-in-picture">Chrome Example Code</a></li>
<li><a href="https://developers.google.com/web/updates/2018/10/watch-video-using-picture-in-picture">Watch video using Picture-in-Picture</a></li>
</ul>
