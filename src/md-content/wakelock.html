<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <style>
    @import "https://unpkg.com/open-props";

  :root {
    font-family: var(--font-sans);
  }

  .card {
    height: 10vh;
    width: 20vw;
    border-radius: var(--radius-2);
    padding: var(--size-fluid-3);
    box-shadow: var(--shadow-2);
  }
  .card:hover {
    box-shadow: var(--shadow-3);
  }
  </style>
</head>
<body>
  <h1>Screen Wake Lock Demo</h1>

<section class="card">
  <div>
    <label><input type="checkbox" id="wakeLockCheckbox"> Activate <code>screen</code> Wake Lock</label>
  </div>
  <div>
    <label><input type="checkbox" id="reacquireCheckbox"> Re-Acquire <code>screen</code> Wake Lock On Visibility Changes</label>
  </div>
  <div>
    <button id="fullScreenButton" type="button">Go Full Screen</button>
  </div>
  <div id="statusDiv"></div>
</section>

<script>
const wakeLockCheckbox = document.querySelector("#wakeLockCheckbox");
const statusDiv = document.querySelector("#statusDiv");
const reaquireCheckbox = document.querySelector("#reacquireCheckbox");
const fullScreenButton = document.querySelector("#fullScreenButton");

fullScreenButton.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullScreenButton.textContent = "Leave Full Screen";
  } else {
    document.exitFullscreen();
    fullScreenButton.textContent = "Enter Full Screen";
  }
});

if ("WakeLock" in window && "request" in window.WakeLock) {
  let wakeLock = null;

  const requestWakeLock = () => {
    const controller = new AbortController();
    const signal = controller.signal;
    window.WakeLock.request("screen", { signal }).catch((e) => {
      if (e.name === "AbortError") {
        wakeLockCheckbox.checked = false;
        statusDiv.textContent = "Wake Lock was aborted";
        console.log("Wake Lock was aborted");
      } else {
        statusDiv.textContent = `${e.name}, ${e.message}`;
        console.error(`${e.name}, ${e.message}`);
      }
    });
    wakeLockCheckbox.checked = true;
    statusDiv.textContent = "Wake Lock is active";
    console.log("Wake Lock is active");
    return controller;
  };

  wakeLockCheckbox.addEventListener("change", () => {
    if (wakeLockCheckbox.checked) {
      wakeLock = requestWakeLock();
    } else {
      wakeLock.abort();
      wakeLock = null;
    }
  });

  const handleVisibilityChange = () => {
    if (wakeLock !== null && document.visibilityState === "visible") {
      wakeLock = requestWakeLock();
    }
  };

  reaquireCheckbox.addEventListener("change", () => {
    if (reaquireCheckbox.checked) {
      document.addEventListener("visibilitychange", handleVisibilityChange);
      document.addEventListener("fullscreenchange", handleVisibilityChange);
    } else {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
      document.removeEventListener("fullscreenchange", handleVisibilityChange);
    }
  });
} else if ("wakeLock" in navigator && "request" in navigator.wakeLock) {
  let wakeLock = null;

  const requestWakeLock = async () => {
    try {
      wakeLock = await navigator.wakeLock.request("screen");
      wakeLock.addEventListener("release", (e) => {
        console.log(e);
        wakeLockCheckbox.checked = false;
        statusDiv.textContent = "Wake Lock was released";
        console.log("Wake Lock was released");
      });
      wakeLockCheckbox.checked = true;
      statusDiv.textContent = "Wake Lock is active";
      console.log("Wake Lock is active");
    } catch (e) {
      wakeLockCheckbox.checked = false;
      statusDiv.textContent = `${e.name}, ${e.message}`;
      console.error(`${e.name}, ${e.message}`);
    }
  };

  wakeLockCheckbox.addEventListener("change", () => {
    if (wakeLockCheckbox.checked) {
      requestWakeLock();
    } else {
      wakeLock.release();
      wakeLock = null;
    }
  });

  const handleVisibilityChange = () => {
    if (wakeLock !== null && document.visibilityState === "visible") {
      requestWakeLock();
    }
  };

  reaquireCheckbox.addEventListener("change", () => {
    if (reaquireCheckbox.checked) {
      document.addEventListener("visibilitychange", handleVisibilityChange);
      document.addEventListener("fullscreenchange", handleVisibilityChange);
    } else {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
      document.removeEventListener("fullscreenchange", handleVisibilityChange);
    }
  });
} else {
  statusDiv.textContent = "Wake Lock API not supported.";
  console.error("Wake Lock API not supported.");
}

</script>
</body>
</html>
