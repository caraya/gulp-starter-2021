# Github Actions for Process Automation

A lot of times we need to build a project every time we make changes. I picked my Gulp publishing process to test if Github actions work with this.

The idea is that every time we push a commit or we close a Pull Request, Github Actions will run the Gulp default build process from the content in the `main` branch.

See the [Github Actions Documentation](https://docs.github.com/en/actions) for more information about the tool, how it works and what you can do with it.

## The First Try

In the first pass, we want to validate that the project is set up correctly and that can run the build process inside the action.

```yaml
name: NodeJS with Gulp

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js 14.x
      uses: actions/setup-node@v1
      with: 
        node-version: 14.x 

    - name: Build
      run: |
        npm install
        gulp
```

The idea remains the same. We want to run the build process for every commit and every pull request made on the `main` branch.

We run the build process usint the `ubuntu-latest` runner available from Github.

We use two actions to run the process:

* [Checkout](https://github.com/actions/checkout) will checkout the code from the repository's `main` branch
* [Setup Node](https://github.com/actions/setup-node) will setup one or more versions of Node.js to run the actions with.

We then create a run action to install the packages and run the default Gulp build task.

## Publish the results

Right now we can build the files but they stay inside the action and we can't see the result, even though we tell Gulp to put the files in the `dist` directory.

To do this we add two  more actions, one to commit the files and a second one to push the results to the `main` branch.

We first set the user's name and email to use in the commit using `git config --local`.

We add all the files to the commit.

If the result of running `git status --porcelain` is empty (has a length of 0), then we set the [workflow command](https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions) to set the `push` flag to false. There is nothing for us to commit.

Otherwise we commit the changes and set the `push` flag to true.

The second action checks if the `push` flag is set to true. If it is it uses the [GitHub Action for GitHub Push](https://github.com/ad-m/github-push-action) action to push the changes to the `main` branch using Github Tokens generated as part of the Actions workflow.

```yaml
    - name: Commit files
      id: commit
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "github-actions"
        git add --all
        if [-z "$(git status --porcelain)"]; then
           echo "::set-output name=push::false"
        else
           git commit -m "Add changes" -a
           echo "::set-output name=push::true"
        fi
      shell: bash

    - name: Push changes
      if: steps.commit.outputs.push == 'true'
      uses: ad-m/github-push-action@master
      with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
```

## Using Github Pages to show the results

Now we have the code generated by the Actions in the repository's main branch the final question is how to show the results to the users.

We could change the build process to point to the `docs` directory instead of `dist`. Once we do that then Github Pages, as configured in the repository settings should take care of the rest.

Another option is to use the [GitHub Pages Deploy Action](https://github.com/JamesIves/github-pages-deploy-action) to deploy the `dist` folder to Github Pages.

## Multiple versions of Node

```yaml
name: NodeJS with Gulp

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x, 14.x, 16.x]
    
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js 14.x${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Build
      run: |
        npm install
        gulp
```
