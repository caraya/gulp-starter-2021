<html lang="en" dir="ltr" class="no-js lazy">

<head>
  <!--<link rel="stylesheet" href="ccs/github.css">-->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/image-load.css">
  <link rel="stylesheet" href="css/video-load.css">
  <link rel="stylesheet" href="css/prism.css">
  <!-- <script async src="scripts/menu.js"></script> -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title></title>
</head>

<body>
<article class="container">
  <h1>Building JSON from the content of a page</h1>
<p>As part of a larger project I had to figure out how to use node to scrape the content of a page to build a JSON file from the components using Node. Rather than scrape the page I discovered a REST API end point that will provide search results as JSON. This is the function I’m using to fetch the JSON, extract its components and build the new JSON object that I’ll pass to other functions.</p>
<p>It is not pretty… I’m the first one to admit that. But it does the work until I find something better :)</p>
<h2>Problem Statement</h2>
<p>As part of building an action for Google assistant that will add voice to the search results for my blog I came up with the following issue:</p>
<blockquote>
<p>How do I provide a JSON payload for assistant to use if the Wordpress generated by the WordPress REST API provides way more information than we need</p>
</blockquote>
<h2>Different solutions</h2>
<p>One quick solution is to scrape the page using tools like <a href="https://www.npmjs.com/package/cheerio">Cheerio</a> but it still only provides HTML content, not the JSON I need. It is possible but the process is cumbersome and we need to change the code every time we change the page.</p>
<p>I could also use the JSON I received from Wordpress as is  but it makes for a large download for only using a fraction of the data in the resulting prodcut.</p>
<p>I decided to go with <a href="https://github.com/bitinn/node-fetch">node-fetch</a> for my solution. Node-fetch is a Node implementation of the WHATWG <a href="https://github.com/whatwg/fetch">fetch standard</a> and allows me to do both promise and async/await code. I went with the later option to make myself be comfortable with async/await.</p>
<p>The code below takes a single parameter representing the query that we want to search for. With that wuery the function will:</p>
<ol>
<li>Create an empty array to store the data we collect</li>
<li>Create an async function</li>
<li>Replace all the spaces in the query parameter with <code>+</code> signs</li>
<li>Await for the fetching of the encoded query. We use a template string literal to interpolate the value of the query</li>
<li>Convert the response to JSON</li>
<li>Using a for loop</li>
<li>Create an item array passing title, link and excerpt. Since the excerpt begins with a HTML tag we strip it by slicing the element starting at position 3 (0-based) and going for 150 characters</li>
<li>Run the element through <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a> and push the result into the <code>jsonData</code> array that we created in step 1</li>
<li>Log any errors to the console</li>
<li>Execute the function with a parameter to search. We make sure that it has two words to exercise all aspects of the function</li>
</ol>
<pre><code class="language-js">const fetch = require('node-fetch');

const jsonData = []; // 1
const buildJSON = async function(query) { // 2
  try {
    encodedQuery = query.replace(new RegExp('\\+', 'g'), ' '); // 3
    const response = await fetch(`https://publishing-project.rivendellweb.net/wp-json/wp/v2/posts?search=${encodedQuery}`); // 4
    const json = await response.json(); // 5
    // Do the work here instead of the console.log
    for (let i = 0; i &lt; json.length; i++) { // 6
      const item = { // 7
        title: json[i].title.rendered,
        link: json[i].link,
        body: json[i].excerpt.rendered.slice(3, 150),
      };
      jsonData.push(JSON.stringify(item)); // 8
    }
  } catch (err) { // 9
    console.log('There\'s been an error getting the data', err);
  };
};

buildJSON('lazy loading'); // 10
</code></pre>
<h2>Conclusion</h2>
<p>While this function was first created to work converting one JSON file into another we can replace the for loop with whatever instructions that we need to accomplish our goals.</p>

</article>
<!--
</div> -->
<script src="scripts/lazy-load.js"></script>
<script src="scripts/vendor/clipboard.min.js"></script>
<script src="scripts/vendor/prism.js"></script>
<script src="scripts/vendor/fontfaceobserver.js"></script>
<script src="scripts/load-fonts.js"></script>
<script src="scripts/lazy-load-video.js"></script>
</body>
</html>