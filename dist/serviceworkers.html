<html lang="en" dir="ltr" class="no-js lazy">

<head>
  <!--<link rel="stylesheet" href="ccs/github.css">-->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/image-load.css">
  <link rel="stylesheet" href="css/video-load.css">
  <link rel="stylesheet" href="css/prism.css">
  <!-- <script async src="scripts/menu.js"></script> -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title></title>
</head>

<body>
<article class="container">
  <h1 id="service-workers%3A-the-easy-and-the-hard-way">Service Workers: The easy and the hard way</h1>
<p>Service Workers are awesome. They give you a performance boost and the capability of limited offline work without having to create apps for each platfomt that we want to use our app in.</p>
<p>Service workers are the core of PWAs (Progressive Web Applications) where we take advantage of a set of web technologies to make apps that work closer to how native apps would.</p>
<p>We’ll concentrate on the service worker and in using Workbox.js and vanilla Javascript to create the service worker. I’ve chosen to go with Workbox first because the abbstraction makes it easier to create the type of abstractions I need.</p>
<p>Once I have a working service worker I will try to duplicate the functionality without libraries to compare how easy/hard it is.</p>
<h2 id="registering-the-service-worker">Registering the service worker</h2>
<p>We register the worker on page load to improve performance. This will work the same whether we’re using a vanilla Javascript service worker or if we implement it using Workbox.</p>
<p>Place the following script tag in the main page of your site or application.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./sw.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker registered'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre>
<h2 id="workbox.js">Workbox.js</h2>
<p>Workbox is a libbrbary from Google that automates the creation of a service worker and hides a lot of the complexities inherent in the service worker creation.</p>
<p>This particular service worker is optimized for performance. We want to cache all the resource and either serve them from the catch falling back to the network or serving cached content while, at the same time, fetching the asset from the network and placing it in the cache for future use.</p>
<h3 id="defining-items-to-precache">Defining Items to Precache</h3>
<p>We have an external configuration file to run Workbox precaching. We’ll talk about the command at the end of the section.</p>
<p>The config file (<code>workbox.config.js</code>) tells us the following things:</p>
<ul>
<li>The source file for the service worker (<code>swSrc</code>)</li>
<li>The destinatioon for the service worker (<code>swDest</code>)</li>
<li>The root for the files we want to precache (<code>globDirectory</code>)</li>
<li>The list of files to precache (<code>globPatterns</code>)</li>
</ul>
<pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'swSrc'</span><span class="token operator">:</span> <span class="token string">'js/sw.js'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'swDest'</span><span class="token operator">:</span> <span class="token string">'sw.js'</span><span class="token punctuation">,</span>

  <span class="token string-property property">'globDirectory'</span><span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'globPatterns'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'index.html'</span><span class="token punctuation">,</span>
    <span class="token string">'css/index.css'</span><span class="token punctuation">,</span>
    <span class="token string">'js/zenscroll.js'</span><span class="token punctuation">,</span>
    <span class="token string">'pages/404.html'</span><span class="token punctuation">,</span>
    <span class="token string">'pages/offline.html'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="workbox-handlers">Workbox Handlers</h3>
<p>I’ve chosen to decouple the routing and the strategies for each type of content that I want to cache.</p>
<p>The first type of content creates the <code>content-cache</code> cache where we will later store cached HTML content</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Cache strategies definitions</span>
<span class="token comment">// HTML caching strategy</span>
<span class="token keyword">const</span> contentHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'content-cache'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The CSS handler will hold our stylesheets, both local and third party, to style the content.</p>
<p>The CSS cache does a couple special things via Workbox plugins:</p>
<ul>
<li>It accepts opaque responses for third party resources that wouldn’t normally be cached
<ul>
<li>It uses the <a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.cacheableResponse.Plugin">cacheableResponse</a> plugin</li>
<li>The status code ‘0’ represents opaque responses</li>
</ul>
</li>
<li>It sets an expiration date to 14 days</li>
<li>It sets the maximum number of items the cache will hold. When the cache is full new entries will push the oldest out of the cache (and delete them)</li>
</ul>
<p>We cache opaque responses at our own risk since we have no way of knowing if the request succeeded or not.  I considered the risk and accepted it because the networks where I’m pulling third party resources from are big and stable (Cloudflare and Google Fonts).</p>
<p>In a future iteration I may want to move third party CSS resources to its own cache like I do with fonts, but I haven’t been able to figure out how to.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// CSS caching strategy</span>
<span class="token keyword">const</span> cssHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'css-cache'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>cacheableResponse<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">statuses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">14</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maxEntries</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The Javascript handler will hold our local and third party scripts.</p>
<p>The cache does a couple special things via Workbox plugins:</p>
<ul>
<li>It accepts opaque responses for third party resources that wouldn’t normally be cached
<ul>
<li>It uses the <a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.cacheableResponse.Plugin">cacheableResponse</a> plugin</li>
<li>The status code ‘0’ represents opaque responses</li>
</ul>
</li>
<li>It sets an expiration date to 14 days</li>
<li>It sets the maximum number of items the cache will hold. When the cache is full new entries will push the oldest out of the cache (and delete them)</li>
</ul>
<p>We cache opaque responses at our own risk since we have no way of knowing if the request succeeded or not.  I considered the risk and accepted it because the networks where I’m pulling third party resources from are big and stable (Cloudflare and Google Fonts)</p>
<p>In a future iteration I may want to move third party JS resources to its own cache like I do with fonts, but I haven’t been able to figure out how to.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> jsHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">staleWhileRevalidate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'scripts-cache'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>cacheableResponse<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">statuses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">14</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maxEntries</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>As a performance improvement one of the best things I can think about doing is caching images so we only take the hit on the large download the first time that we download an image. Not saying we don’t need to optimize them but want to make sure that images load as fast as possible and that means that we should load them from cache if possible.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> imageHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'image-cache'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// Cache for a maximum of 30 days</span>
      <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Fonts will be the largest assets we cache with the service worker so we want to keep a few around and keep them for a while so we don’t have to download them as often. This is particularly important because the primary font, Roboto variable font, is 1MB in size when compressed as a woff2 font.</p>
<p>We’re keeping 5 locally hosted fonts (ones that are not served through Google fonts) and keeping them for 30 days although I may want to cache them longer and keep more of them, particularly if I work with smaller font subsets.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fontHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'fonts-cache'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maxEntries</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>External resources present an interesting problem when working with service workers. All responses from third party resources up vote are ‘opaque’ responses and represent the result of a request made to a remote origin when CORS is not enabled.</p>
<p>Caching opaque request makes it imposible for Workbox to detect and warn you if the request failed (there is no status code to tell it, and you, that it failed).</p>
<p>Workbox will cache opaque resources when using uses <code>networkFirst</code> or <code>staleWhileRevalidate</code> as the strategy. Both of this strategies will query the network first (<code>networkFirst</code>) or will query the network regardless of success or failure (<code>staleWhileRevalidate</code>)</p>
<p>To make sure that the resources are cached we use the <a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.cacheableResponse.Plugin">cacheableResponse</a> plugin to tell Workbox that we want it to cache resources with a status code of <code>0</code>, regardless of the strategy we use.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> extFontHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'external-fonts'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maxEntries</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>cacheableResponse<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">statuses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="defining-routes">Defining routes</h3>
<p>The next step is to create routes that will use the strategies we just defined to cache the content and, where appropriate, provide fallback options.</p>
<p>These routes use Workbox routing and its <code>registerRoute</code> method to associate a file or extension, a handler (defined above) and zero or more additional conditions for each route.</p>
<p>I’ve broken he routes based on content and, where appropriate, on referring source.</p>
<p>The first type of resource that we cache outside of the precache. We make sure that there is a response and then do one of three things:</p>
<ul>
<li>If there is no response then provide an offline page</li>
<li>If the page is not found then return a 404 page</li>
<li>If there is an error then give the user an error page</li>
</ul>
<pre class="language-js"><code class="language-js"><span class="token comment">// Routing Definitions and Fallbacks</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\.html</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> contentHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'pages/offline.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'pages/404.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'pages/error.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Next, we handle CSS requests and match them to the CSS extension. If there is no response or the response status is 404 we return nothing.</p>
<p>If there is an error we return nothing.</p>
<p>With CSS I don’t want to store anything in the cache that is not CSS unlike what we did with HTML where we wanted different responses for each event.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">//  CSS other than index.css</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\.css</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> cssHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response <span class="token operator">||</span> response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The route that handles Javascript uses the handler we defined earlier without any major adjustments. If the route is not OK it’ll produce an error which is what we want. Javascript failuers will usually render the site or app unusable.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// JS other than index.js and any JSON file</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jsHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>When caching fonts we want to make sure that the browser caches all font formats that we may want to use (even though we only use woff2 fonts locally) to give ourselves the flexibility of using other formats without having to change the route later.</p>
<p>This will only cache local fonts, not those loaded from Google Fonts; we’ll handle third party fonts in a different route.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Fonts</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\.(?:ttf|otf|woff|woff2)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> fontHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This route will handle fonts loaded from Google Fonts. The URL may bbe <code>fonts.googleapis</code> or <code>fonts.gstatic</code> so we create a new regular expression that matches both sites and stores the fonts in a different cache than our local fonts.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Third party fonts</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https:\/\/fonts\.(googleapis|gstatic)\.com</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> extFontHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>When we look at images we need to make sure that we’re caching all the kinds of images that we plan on using.</p>
<p>The route we’re creating includes all image formats except<a href="https://developers.google.com/speed/webp/">WebP</a> since it’s not widely supported but we include both GIF and SVG.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Images.</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\.(?:png|jpg|jpeg|svg|gif)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> imageHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="injecting-the-pre-cache-items">Injecting the pre-cache items</h3>
<p>The final step is to incorporate the precache files that we defined in <code>workbox-config.js</code> into the service worker file.</p>
<p>The command requires you to install the workbox node module globally</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">npm</span> <span class="token function">install</span> workbox-cli <span class="token parameter variable">--global</span>
</code></pre>
<p>The module makes the <code>workbox</code>  command available on the terminal. Once installed, run the following command to inject the files we want to precache into the service worker.</p>
<pre class="language-sh"><code class="language-sh">workbox injectManifest workbox-config.js
</code></pre>
<h3 id="additional-enhancements">Additional Enhancements</h3>
<p>There are a few things that I’m working on beyond the service worker that we described in the previous sections.</p>
<h4 id="local-videos">Local Videos</h4>
<p>We are still using animated GIFs to create animations and demos. We may be able to <a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/replace-animated-gifs-with-video/">create smaller animations using MP4 video instead of GIF</a> but until we do the GIF images stay in this cache. We’ll use the video cache to store any other videos that we download locally, not from Youtube or Vimeo.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> videoHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'videos-cache'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">180</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The route will match 4 types of video: WebM, MP4, OGG and AV1. These videos will download locally, not from Youtube or Vimeo. We’ll handle that in a different route</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// videos.</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*\.(?:webm|mp4|ogg|mkv)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> videoHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="third-party-videos">Third Party Videos</h4>
<p>The previous route handles video loaded using the <code>video</code> tag hosted locally and using one of the formats that are common for HTML video.</p>
<p>The problem is that this may be too quick to fill out the storage quota for the domain. I’m still torn between using this strategy that will load from cache and then fall back to the network and using a netowrk only strategy to save bandwidth and disk space.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> extVideoHandler <span class="token operator">=</span> workbox<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span><span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">cacheName</span><span class="token operator">:</span> <span class="token string">'external-video'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">maxAgeSeconds</span><span class="token operator">:</span> <span class="token number">180</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">workbox<span class="token punctuation">.</span>cacheableResponse<span class="token punctuation">.</span>Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">statuses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The regular expression used in this route matches the pages and the embeds for both Vimeo and Youtube.</p>
<pre class="language-js"><code class="language-js">workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">^</span><span class="token punctuation">(</span>https<span class="token operator">:</span>\<span class="token operator">/</span>\<span class="token operator">/</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>player\<span class="token punctuation">.</span>vimeo<span class="token punctuation">.</span>com<span class="token operator">|</span>www\<span class="token punctuation">.</span>youtube\<span class="token punctuation">.</span>com<span class="token punctuation">)</span>
\<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([\w\/]+)([\?].*)?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extVideoHandler</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Because the regular expression is more complex than I’m used to I’ve chosen to document it to make sure that I remember what it’s supposed to do.</p>
<ul>
<li><code>^</code> asserts position at start of a line</li>
<li>1st Capturing Group (https://)
<ul>
<li><code>https:</code> matches the characters https: literally (case sensitive)</li>
<li><code>\/</code> matches the character / literally (case sensitive)</li>
<li><code>\/</code> matches the character / literally (case sensitive)</li>
</ul>
</li>
<li>2nd Capturing Group <code>(player\.vimeo.com|vimeo\.com|www\.youtube\.com)</code></li>
<li>1st Alternative <a href="http://player.vimeo.com">player.vimeo.com</a>
<ul>
<li><code>player</code> matches the characters player literally (case sensitive)</li>
<li><code>\.</code> matches the character . literally (case sensitive)</li>
<li><code>vimeo</code> matches the characters vimeo literally (case sensitive)</li>
<li><code>.</code> matches any character (except for line terminators)</li>
<li><code>com</code> matches the characters com literally (case sensitive)</li>
</ul>
</li>
<li>2nd Alternative <code>vimeo\.com</code>
<ul>
<li><code>vimeo</code> matches the characters vimeo literally (case sensitive)</li>
<li><code>\.</code> matches the character . literally (case sensitive)</li>
<li><code>com</code> matches the characters com literally (case sensitive)</li>
</ul>
</li>
<li>3rd Alternative <code>www\.youtube\.com</code>
<ul>
<li><code>www</code> matches the characters www literally (case sensitive)</li>
<li><code>\.</code> matches the character . literally (case sensitive)</li>
<li><code>youtube</code> matches the characters youtube literally (case sensitive)</li>
<li><code>\.</code> matches the character . literally (case sensitive)</li>
<li><code>com</code> matches the characters com literally (case sensitive)</li>
<li><code>\/</code> matches the character / literally (case sensitive)</li>
</ul>
</li>
<li>3rd Capturing Group <code>([\w\/]+)</code>
<ul>
<li>Match a single character present in the list below [\w/]+</li>
<li><code>+</code> Quantifier — Matches between one and unlimited times, as many times as possible, giving back as needed (greedy)</li>
<li><code>\w</code> matches any word character (equal to [a-zA-Z0-9_])</li>
<li><code>\/</code> matches the character / literally (case sensitive)</li>
</ul>
</li>
<li>4th Capturing Group ([?].*)?
<ul>
<li><code>?</code> Quantifier — Matches between zero and one times, as many times as possible, giving back as needed (greedy)</li>
<li>Match a single character present in the list below [?]</li>
<li><code>\?</code> matches the character ? literally (case sensitive)</li>
<li><code>.*</code> matches any character (except for line terminators)</li>
<li><code>$</code> asserts position at the end of a line</li>
</ul>
</li>
</ul>
<h2 id="%E2%80%9Cvanilla%E2%80%9D-javascript%2C-no-libraries">“Vanilla” Javascript, no libraries</h2>
<p>The idea is to create the service worker using only native APIs and seeing how much of the Workbox functionality I can duplicate without having to use a library.</p>
<h3 id="constants-and-common-items">Constants and common items</h3>
<p>Individual constants for each of the caches. We store them separately so we can change the names to make cleanup easier without having to change the array we define later.</p>
<pre class="language-js"><code class="language-js">
<span class="token keyword">const</span> <span class="token constant">PRECACHE</span> <span class="token operator">=</span> <span class="token string">'precache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CONTENT</span> <span class="token operator">=</span> <span class="token string">'content-cache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CSS</span> <span class="token operator">=</span> <span class="token string">'css-cache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">JS</span> <span class="token operator">=</span> <span class="token string">'scripts-cache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IMAGES</span> <span class="token operator">=</span> <span class="token string">'image-cache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FONTS</span> <span class="token operator">=</span> <span class="token string">'fonts-cache-v1'</span><span class="token punctuation">;</span>
</code></pre>
<p>expectedCaches is the array of cache names we expect to exists in the client.</p>
<p>If they don’t we’re fine, we fetch from network; If they do, we’re fine, we fetch from cache and if they exist with a different version then we delete the old one</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> expectedCaches <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token constant">PRECACHE</span><span class="token punctuation">,</span>
  <span class="token constant">CONTENT</span><span class="token punctuation">,</span>
  <span class="token constant">CSS</span><span class="token punctuation">,</span>
  <span class="token constant">JS</span><span class="token punctuation">,</span>
  <span class="token constant">IMAGES</span><span class="token punctuation">,</span>
  <span class="token constant">FONTS</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p><code>urlsToPrecache</code> is the list of URLs that we want to cache on install. The <code>/</code> URL indicates the root file, in this case, index.html</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> urlsToPrecache <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'/index.html'</span><span class="token punctuation">,</span>
  <span class="token string">'/css/index.css'</span><span class="token punctuation">,</span>
  <span class="token string">'/js/zenscroll.js'</span><span class="token punctuation">,</span>
  <span class="token string">'/404.html'</span><span class="token punctuation">,</span>
  <span class="token string">'/offline.html'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="install-event">Install Event</h3>
<p>The install event will take all the URLs in the <code>urlsToPrecache</code> array</p>
<pre class="language-js"><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'install event fired'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">PRECACHE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">precache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> precache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>urlsToPrecache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ends wait until</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ends install event</span>
</code></pre>
<h3 id="activate-event">Activate Event</h3>
<p>Activate will perform cleanup on the caches.</p>
<p>If there is a cache that doesn’t exist in the Array that we pass to the event then it’s deleted This is the reason why we went through such a convoluted way to define the caches. We can change the names individually and then they’ll get deleted the next time the user visits the site.</p>
<pre class="language-js"><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  clients<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
  caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">keys</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// if the cache is not one in the list</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expectedCaches<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// delete it</span>
        <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Everything cleaned up'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="fetch-event">Fetch Event</h3>
<p>The fetch event is where most of the work will happen. Unlike the work in Workbox service worker we don’t break the routes into different blocks in the vanilla service worker.</p>
<p>There are some aspects where the vanilla service worker still doesn’t match the Workbox implementation.</p>
<p>All the following sections are inside the fetch event listener. I’ve broken them down for ease of reading.</p>
<p>This is an important item to remember for all fetch handlers that put resources in caches using the cache API:</p>
<p><em><strong>Put a copy of the response in the cache, otherwise the code will throw an exception because response is a stream that can only be consumed once</strong></em></p>
<p>When we define the event we do two things right away:</p>
<p>We define a constant to hold the vaslues of the event’s request object.</p>
<p>If the request doesn’t match the <code>GET</code> HTTP method we return without doing anything. The service worker will only work with GET requests.</p>
<pre class="language-js"><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> event<span class="token punctuation">.</span>request<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>The first handler is for fonts. Since the fonts are requested from the <code>typography-*.css</code> stylesheets I have to make sure that the font is loaded from the stylesheet or that the file ends in one of the four font formats I work with.</p>
<pre class="language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(ttf|otf|woff|woff2)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>request<span class="token punctuation">.</span>referrer<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'typography'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
      <span class="token comment">// Open the fonts cache</span>
      caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">FONTS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// return the font to the user</span>
          <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// Open the cache</span>
          caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">FONTS</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// Fetch the resource from the network</span>
            <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
              <span class="token comment">// Put a copy of the resource in the cache</span>
              <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>Caching Javascript resources has a different objective: To cache all the Javascript files that are not in the install precache. The match query means include all files with a <code>.js</code> extension except one that includes <code>zenscroller</code> in the URL (Zenscroller is cached at install).</p>
<pre class="language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(js)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'zenscroll'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
      caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">JS</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">JS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// Return the response</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>For CSS we want to make sure we cache all files with a <code>.css</code> extension and that are not fonts (denoted by a <code>.woff2</code> extension).</p>
<pre class="language-js"><code class="language-js">  <span class="token comment">// two places. Working on figuring out a solution</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(css)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
      <span class="token comment">// Open the content cache</span>
      caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CSS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// return the CSS to the user</span>
          <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// Open the cache</span>
          <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CSS</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// Fetch the resource from the network</span>
            <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
              <span class="token comment">// Put a copy of the response in the cache</span>
              <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// Return the response</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>In the cache for images we want to make sure that we add only images only (those that match <code>jpeg</code>, <code>jpg</code>, <code>png</code>, <code>gif</code> and <code>svg</code>) and not the assets that reference the images (HTML and CSS).</p>
<p>If the image is not in the cache and we can’t retrieve it from the network we provide a local fallback as a new response using an SVG image.</p>
<pre class="language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(jpe?g|png|gif|svg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'/\.(html|css)$/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
      caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">IMAGES</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// return the IMAGES to the user</span>
        <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// Open the cache</span>
        <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">IMAGES</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// Fetch the resource from the network</span>
          <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// Put a copy of the response in the cache</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
              <span class="token comment">// Return the response</span>
              <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token constant">OFFLINESVG</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'image/svg+xml'</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// If we get to here, bail out</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>The final handler for assets is for HTML content by using a stale while revalidate strategy, we return the resource in the cache, if it’s not in the cache then we fetch it from the network, store a copy of the response in the cache and return the resource to the user.</p>
<p>In this cache we could be more sophisticated and return different responses based on whether we’re offline, the resource was not found or any other network failure. But for an MVP, this is enough.</p>
<pre class="language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Accept'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Open the content cache</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CONTENT</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// return the content to the user</span>
      <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Open the cache</span>
      caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CONTENT</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// Fetch the resource from the network</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// Put a copy of the response in the cache</span>
          cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// Return the response</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

</article>
<!--
</div> -->
<script src="scripts/lazy-load.js"></script>
<script src="scripts/vendor/clipboard.min.js"></script>
<script src="scripts/vendor/prism.js"></script>
<script src="scripts/vendor/fontfaceobserver.js"></script>
<script src="scripts/load-fonts.js"></script>
<script src="scripts/lazy-load-video.js"></script>
</body>
</html>