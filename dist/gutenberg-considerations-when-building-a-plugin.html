<html lang="en" dir="ltr" class="no-js lazy">

<head>
  <!--<link rel="stylesheet" href="ccs/github.css">-->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/image-load.css">
  <link rel="stylesheet" href="css/video-load.css">
  <link rel="stylesheet" href="css/prism.css">
  <!-- <script async src="scripts/menu.js"></script> -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title></title>
</head>

<body>
<article class="container">
  <h1 id="plugin-topics%3A-metaboxes-in-the-block-editor">Plugin Topics: Metaboxes in the Block Editor</h1>
<p>Meta boxes work in Gutenberg but they may not do so for a while or be the best solution for your needs.</p>
<p>During the full migration to the Block Editor, WordPress Provides two <a href="https://make.wordpress.org/core/2018/11/07/meta-box-compatibility-flags/">compatibility flags</a>.</p>
<p>Most of the time the compatibility setup works out of the box. However you must testing the metaboxes on Gutenberg to make sure the code will still work and that you won’t need to write new blocks to handle the meta box data.</p>
<p>You also need to modify the <code>add_meta_box()</code> function to look like the example that follows:</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">rivendellweb_custom_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">add_meta_box</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'rivendellweb_meta'</span><span class="token punctuation">,</span>
    <span class="token function">__</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Meta Box Title'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb-textdomain'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'rivendellweb_meta_callback'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'post'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'advanced'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'default'</span><span class="token punctuation">,</span>
    <span class="token keyword">array</span><span class="token punctuation">(</span>
      <span class="token string single-quoted-string">'__block_editor_compatible_meta_box'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'__back_compat_meta_box'</span>             <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'add_meta_boxes'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_custom_meta'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2 id="moving-forward%3A-store-and-read-post-meta-with-a-block">Moving Forward: Store and Read Post Meta With A Block</h2>
<p>Meta boxes are not a good solution for providing custom text when working with Gutenberg in the long run. The best solution is to work with meta blocks, the Gutenberg equivalent of meta boxes.</p>
<p>As with many things in Gutenberg, you will se multiple ways to accomplish this; some of the factos involved:</p>
<ul>
<li>Whether you want to use ES5 or ES6+ to write Javascript</li>
<li>Wheter you want to use JSX or not.</li>
</ul>
<p>This plugin will assume you are using ES6+ and JSX. It will also assume that you’ve initialized a block using the following command:</p>
<pre class="language-text"><code class="language-text">npm init @wordpress/block
</code></pre>
<p>The command will create the block directory, install <code>@wordpress/scripts</code> and all the necesssary dependencies, configure the block and provide a set of commands you can run during development, finishing up with building the block for production.</p>
<h2 id="registering-meta-attributes-in-php">Registering meta attributes in PHP</h2>
<p>The first step is to register the meta attributes we want to use in the block in the block’s PHP file. We can register as many meta fields as we need to inside the function, they will all be instantiated when the init action runs.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// register one or more custom meta tag fields</span>
<span class="token keyword">function</span> <span class="token function-definition function">rivendellweb_register_post_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">register_post_meta</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'post'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_rivendellweb_protected_key'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
      <span class="token string single-quoted-string">'show_in_rest'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'single'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'type'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'string'</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'auth_callback'</span> <span class="token operator">=></span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">current_user_can</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'edit_posts'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'init'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_register_post_meta'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2 id="build-the-block-in-javascript%2Fjsx">Build the block in Javascript/JSX</h2>
<p>Now we move to the React-centric Gutenberg block creation process.</p>
<p>The first task is to import all the functions we’ll need from the corresponding <code>@wordpress</code> scoped packages.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> registerBlockType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/blocks'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TextControl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/components'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useSelect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/data'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useEntityProp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/core-data'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useBlockProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/block-editor'</span><span class="token punctuation">;</span>
</code></pre>
<p>We then call the <a href="https://developer.wordpress.org/block-editor/reference-guides/block-api/block-registration/#registerblocktype">registerBlockType()</a> function to register the block.</p>
<pre class="language-js"><code class="language-js"><span class="token function">registerBlockType</span><span class="token punctuation">(</span> <span class="token string">'rivendellweb/meta-block'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">'Meta Block'</span><span class="token punctuation">,</span>
  icon<span class="token operator">:</span> <span class="token string">'smiley'</span><span class="token punctuation">,</span>
  category<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>

  <span class="token function">edit</span><span class="token punctuation">(</span> <span class="token parameter"><span class="token punctuation">{</span> setAttributes<span class="token punctuation">,</span> attributes <span class="token punctuation">}</span></span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> blockProps <span class="token operator">=</span> <span class="token function">useBlockProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> postType <span class="token operator">=</span> <span class="token function">useSelect</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span> <span class="token parameter">select</span> <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">select</span><span class="token punctuation">(</span> <span class="token string">'core/editor'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentPostType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> meta<span class="token punctuation">,</span> setMeta <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useEntityProp</span><span class="token punctuation">(</span> <span class="token string">'postType'</span><span class="token punctuation">,</span> postType<span class="token punctuation">,</span> <span class="token string">'meta'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> metaFieldValue <span class="token operator">=</span> meta<span class="token punctuation">[</span> <span class="token string">'rivendellweb_meta_block_field'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">updateMetaValue</span><span class="token punctuation">(</span> <span class="token parameter">newValue</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setMeta</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token operator">...</span>meta<span class="token punctuation">,</span> rivendellweb_meta_block_field<span class="token operator">:</span> newValue <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div <span class="token punctuation">{</span> <span class="token operator">...</span>blockProps <span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>TextControl
          label<span class="token operator">=</span><span class="token string">"Meta Block Field"</span>
          value<span class="token operator">=</span><span class="token punctuation">{</span> metaFieldValue <span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span> updateMetaValue <span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Data is saved to post meta via the hook</span>
  <span class="token comment">// so we don't need to save it in the block</span>
  <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Before we build the plugin, we need to enqueue the scripts for the plugin and all its dependencies. We use <a href="https://developer.wordpress.org/reference/functions/wp_enqueue_script/">wp_enqueue_script()</a> like we do to add all scripts to a WordPress installation.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">rivendellweb_enqueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">wp_enqueue_script</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'rivendellweb-script'</span><span class="token punctuation">,</span>
    <span class="token function">plugins_url</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'rivendellweb.js'</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp-blocks'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wp-element'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wp-components'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wp-data'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wp-core-data'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wp-block-editor'</span> <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'enqueue_block_editor_assets'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_enqueue'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h3 id="build-the-block">Build the block</h3>
<p>Once we’ve written all the code, registered blocks and meta fields we can build the block.</p>
<p>From the root of the plugin run the following NPM command:</p>
<pre class="language-text"><code class="language-text">npm run build
</code></pre>
<p>Assuming there are no errors, you can zip the directory and upload it to your testing and production WordPress installations.</p>
<h2 id="putting-the-meta-block-on-the-sidebar">putting the meta block on the sidebar</h2>
<p>Rather than using a block to display the meta box to enter data, it may be a better idea to put it on the editor side bar.</p>
<p>Doing so makes the meta box available at all times and is a good way to make the meta box more visible and ensure the user adds the data to the post. We can also write additional PHP code that will ensure it works regardless of the editor you use.</p>
<p><code>compat.php</code> has all the code necessary to make the meta box work in the classic editor. We use <a href="https://www.php.net/manual/en/function.include-once.php">include_once</a> to include the file once. I will not cover the content of the file in this post.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">include_once</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'src/compat.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<p>The first PHP function we use will create the meta field, make it available on the REST API so it’ll be usable in the block editor and provide sanitization and authorization callbacks.</p>
<p>The <code>sanitize_callback</code> callback uses the built-in <a href="https://developer.wordpress.org/reference/functions/sanitize_text_field/">sanitize_text_field()</a> function to make sure the input is clean before saving it to the database.</p>
<p>The <code>auth_callback</code> callback ensures that the person using the meta box can edit the post before being allowed to save the meta box data. It uses <a href="https://developer.wordpress.org/reference/functions/current_user_can/">current_user_can()</a> to perform the check.</p>
<p>We add the action to the <a href="https://developer.wordpress.org/reference/hooks/init/">init</a> hook so it’s available before we load the block.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">rivendellweb_register_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">register_meta</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_rivendellweb_text_metafield'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'show_in_rest'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'type'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'string'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'single'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'sanitize_callback'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'sanitize_text_field'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'auth_callback'</span> <span class="token operator">=></span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">current_user_can</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'edit_posts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'init'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_register_meta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<p>The second function enqueues the script for the meta box using <a href="https://developer.wordpress.org/reference/functions/wp_enqueue_script/">wp_enqueue_script()</a>.</p>
<p>Note t hat we’re passing an array of script our code depends on as the last argument. We’ll look at these scripts later when we load and import them from Javascript.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">rivendellweb_enqueue_assets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">wp_enqueue_script</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'metabox-sidebar'</span><span class="token punctuation">,</span>
    <span class="token function">plugins_url</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'build/index.js'</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">array</span><span class="token punctuation">(</span>
      <span class="token string single-quoted-string">'wp-plugins'</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'wp-edit-post'</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'wp-i18n'</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'wp-components'</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'wp-data'</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'wp-element'</span> <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'enqueue_block_editor_assets'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_enqueue_assets'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<p>The next file we’ll look at is <code>build/index.js</code>, the file that will actually create the meta box.</p>
<p>This is a React file but it’s not like most other React projects.</p>
<p>We first import the files that packages we want to use. These are all in the <code>@wordpress</code> scoped namespace. Note that we don’t import React itself, this is handled by a default package, <code>wp-element</code>, a WordPress-specific layer built on top of the React package.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  registerPlugin
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/plugins'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  PluginSidebar<span class="token punctuation">,</span> 
  PluginSidebarMoreMenuItem
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/edit-post'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> __ <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wordpress/i18n'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  PanelBody<span class="token punctuation">,</span>
  TextControl
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@wordpress/components"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  withSelect<span class="token punctuation">,</span>
  withDispatch
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@wordpress/data"</span><span class="token punctuation">;</span>
</code></pre>
<p>The first function builds the meta box. It handles the layout and calling the appropriate function to render the data if it exists and to save it when the user updates or publishes the page.</p>
<p>The values for the text control <code>value</code> and <code>onChange</code> properties are generated by functions and passed as props to the control.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">PluginMetaFields</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>PanelBody
        title<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">"Meta Fields Panel"</span><span class="token punctuation">,</span> <span class="token string">"textdomain"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        icon<span class="token operator">=</span><span class="token string">"admin-post"</span>
        intialOpen<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token operator">&lt;</span>TextControl
          value<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>text_metafield<span class="token punctuation">}</span>
          label<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">"Text Meta"</span><span class="token punctuation">,</span> <span class="token string">"textdomain"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> props<span class="token punctuation">.</span><span class="token function">onMetaFieldChange</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>PanelBody<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The next two funnctions create <a href="https://reactjs.org/docs/higher-order-components.html">higher order components (HOCs)</a> to handle the state of the meta box.</p>
<p>The first component uses <a href="https://developer.wordpress.org/block-editor/reference-guides/packages/packages-data/#withselect">withSelect</a> to inject the value of the meta field into the component. This is why whenever we return to a page with a meta box, the value of the meta field will be shown in the meta box.</p>
<p>The second component saves the meta field data to the database when the user updates or published the post. It uses <a href="https://developer.wordpress.org/block-editor/reference-guides/packages/packages-data/#withdispatch">withDispatch</a> to update the specified meta field with the new data</p>
<p>For a good walkthrough of HOCs in Javascript and React see <a href="https://www.smashingmagazine.com/2020/06/higher-order-components-react/">Higher-Order Components In React</a> by Shedrack Akintayo in <a href="https://www.smashingmagazine.com/">Smashing Magazine</a></p>
<pre class="language-js"><code class="language-js">PluginMetaFields <span class="token operator">=</span> <span class="token function">withSelect</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">select</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      text_metafield<span class="token operator">:</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'core/editor'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEditedPostAttribute</span><span class="token punctuation">(</span><span class="token string">'meta'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'_rivendellweb_text_metafield'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>PluginMetaFields<span class="token punctuation">)</span><span class="token punctuation">;</span>

PluginMetaFields <span class="token operator">=</span> <span class="token function">withDispatch</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onMetaFieldChange</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'core/editor'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">editPost</span><span class="token punctuation">(</span><span class="token punctuation">{</span>meta<span class="token operator">:</span> <span class="token punctuation">{</span>_rivendellweb_text_metafield<span class="token operator">:</span> value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>PluginMetaFields<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The final function add the meta box to the top navigation of the editor and wires it so that when you click the top navigation item (the smily icon) the metabox will be shown.</p>
<pre class="language-js"><code class="language-js"><span class="token function">registerPlugin</span><span class="token punctuation">(</span> <span class="token string">'rivendellweb-sidebar'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  icon<span class="token operator">:</span> <span class="token string">'smiley'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>PluginSidebarMoreMenuItem
          target<span class="token operator">=</span><span class="token string">"rivendellweb-sidebar"</span>
        <span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">'Meta Options'</span><span class="token punctuation">,</span> <span class="token string">'textdomain'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>PluginSidebarMoreMenuItem<span class="token operator">></span>
        <span class="token operator">&lt;</span>PluginSidebar
          name<span class="token operator">=</span><span class="token string">"rivendellweb-sidebar"</span>
          title<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">'Meta Options'</span><span class="token punctuation">,</span> <span class="token string">'textdomain'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">></span>

        <span class="token operator">&lt;</span>PluginMetaFields <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>PluginSidebar<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Now we have a meta box that work in both the block and classic editors so we don’t need to worry about compatbility :)</p>
<figure>
  <img src='https://publishing-project.rivendellweb.net/wp-content/uploads/2021/08/metabox-1.png' alt='Custom WordPress metabox viewed in the block editor' width='width' height='height'>
  <figcaption>Custom WordPress metabox viewed in the block editor</figcaption>
</figure>
<figure>
  <img src='https://res.cloudinary.com/dfh6ihzvj/images/v1628110075/publishing-project.rivendellweb.net/metabox-2/metabox-2.png?_i=AA' alt='WordPress custom metabox viewed in the classic editor' width='100%' height='auto'>
  <figcaption>WordPress custom metabox viewed in the classic editor</figcaption>
</figure>
<h2 id="using-the-meta-block-data">Using the meta block data</h2>
<p>Regardless of how we capture the data, we also need a way to display it. Currently there are two ways to do so.</p>
<h3 id="use-post-meta-in-php-actions">Use Post Meta in PHP actions</h3>
<p>The first way is to use PHP to insert content to the page using the value of the metabox.</p>
<p>This example will add the meta box data to the content of the page by using the <a href="https://developer.wordpress.org/reference/functions/the_content/">the_content</a> hook to add the processed data to the existing content.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">rivendellweb_content_filter</span><span class="token punctuation">(</span> <span class="token variable">$content</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span> <span class="token function">get_the_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_meta_block_field'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$value</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"%s &lt;h4> %s &lt;/h4>"</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token function">esc_html</span><span class="token punctuation">(</span> <span class="token variable">$value</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'the_content'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'rivendellweb_content_filter'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h3 id="use-post-meta-in-block">Use Post Meta in Block</h3>
<p>The second way is to use the post meta data in blocks. This example appends the data to the end of every Paragraph block when it is rendered. You can do this for any core or custom block types as needed.</p>
<p>The <code>rivendellweb_render_paragraph()</code> function sets up the content we want to use, in this case the escaped meta value.</p>
<p>We then use <a href="register_block_type">register_block_type()</a> in PHP to set a callback when the block is rendered to include the meta value.</p>
<p>In this case we register the callback for all paragraph blocks. We could do it for any block type we’ve installed</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">rivendellweb_render_paragraph</span><span class="token punctuation">(</span> <span class="token parameter">$block_attributes<span class="token punctuation">,</span> $content</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $value <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span> <span class="token function">get_the_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'rivendellweb_meta_block_field'</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// check value is set before outputting</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> $value <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span> <span class="token string">"%s (%s)"</span><span class="token punctuation">,</span> $content<span class="token punctuation">,</span> <span class="token function">esc_html</span><span class="token punctuation">(</span> $value <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> $content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">register_block_type</span><span class="token punctuation">(</span> <span class="token string">'core/paragraph'</span><span class="token punctuation">,</span> <span class="token function">array</span><span class="token punctuation">(</span>
    <span class="token string">'api_version'</span> <span class="token operator">=></span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string">'render_callback'</span> <span class="token operator">=></span> <span class="token string">'rivendellweb_render_paragraph'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

</article>
<!--
</div> -->
<script src="scripts/lazy-load.js"></script>
<script src="scripts/vendor/clipboard.min.js"></script>
<script src="scripts/vendor/prism.js"></script>
<script src="scripts/vendor/fontfaceobserver.js"></script>
<script src="scripts/load-fonts.js"></script>
<script src="scripts/lazy-load-video.js"></script>
</body>
</html>